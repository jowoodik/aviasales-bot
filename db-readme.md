# üìä –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø: –°–¢–†–£–ö–¢–£–†–ê –ë–ê–ó–´ –î–ê–ù–ù–´–•

## üóÇÔ∏è –û–±–∑–æ—Ä —Ç–∞–±–ª–∏—Ü

–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–¥–µ—Ä–∂–∏—Ç **12 –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü**:

1. **user_settings** - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. **unified_routes** - –º–∞—Ä—à—Ä—É—Ç—ã (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏ –≥–∏–±–∫–∏–µ)
3. **route_results** - –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –±–∏–ª–µ—Ç—ã
4. **route_check_stats** - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫
5. **combination_check_results** - –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–æ–∫
6. **price_analytics** - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ü–µ–Ω
7. **user_stats** - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
8. **user_subscriptions** - –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
9. **subscription_types** - —Ç–∏–ø—ã –ø–æ–¥–ø–∏—Å–æ–∫
10. **notification_cooldown** - —Ç–∞–π–º–∞—É—Ç—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
11. **üì¢ broadcasts** - –º–∞—Å—Å–æ–≤—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏ (–Ω–æ–≤–æ–µ)
12. **üì¢ broadcast_log** - –ª–æ–≥–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–æ–∫ (–Ω–æ–≤–æ–µ)

***

## üîó –î–ò–ê–ì–†–ê–ú–ú–ê –°–í–Ø–ó–ï–ô

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   user_settings     ‚îÇ
‚îÇ  (chat_id - PK)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ 1
           ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚îÇ N                         ‚îÇ N             ‚îÇ N
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  unified_routes     ‚îÇ     ‚îÇ broadcast_log        ‚îÇ  ‚îÇ user_          ‚îÇ
‚îÇ  (id - PK)          ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  (chat_id - FK)      ‚îÇ  ‚îÇ subscriptions  ‚îÇ
‚îÇ  (chat_id - FK)     ‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ N
           ‚îÇ 1                         ‚îÇ N
           ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚îÇ N        ‚îÇ N       ‚îÇ N       ‚îÇ            ‚îÇ N
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ route_results  ‚îÇ ‚îÇroute_  ‚îÇ ‚îÇcombination‚îÇ ‚îÇ   broadcasts        ‚îÇ ‚îÇ price_analytics   ‚îÇ
‚îÇ (route_id-FK)  ‚îÇ ‚îÇcheck_  ‚îÇ ‚îÇ_check_    ‚îÇ ‚îÇ   (id - PK)         ‚îÇ ‚îÇ (route_id - FK)   ‚îÇ
‚îÇ                ‚îÇ ‚îÇstats   ‚îÇ ‚îÇresults    ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ (chat_id - FK)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ(FK)    ‚îÇ ‚îÇ(FK)       ‚îÇ                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ user_subscriptions  ‚îÇ    N:1  ‚îÇ subscription_types  ‚îÇ
‚îÇ (chat_id - FK)      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ (name - PK)         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ notification_       ‚îÇ
‚îÇ cooldown            ‚îÇ
‚îÇ (chat_id - PK)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   user_stats        ‚îÇ
‚îÇ (chat_id - PK)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

***

## üìã –î–ï–¢–ê–õ–¨–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï –¢–ê–ë–õ–ò–¶

### 1Ô∏è‚É£ **user_settings** (–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –•—Ä–∞–Ω–∏—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–æ—Ç–∞

```sql
CREATE TABLE user_settings (
    chat_id INTEGER PRIMARY KEY,           -- Telegram chat ID
    quiet_hours_start INTEGER DEFAULT 23,  -- –ù–∞—á–∞–ª–æ —Ç–∏—Ö–∏—Ö —á–∞—Å–æ–≤
    quiet_hours_end INTEGER DEFAULT 7,     -- –ö–æ–Ω–µ—Ü —Ç–∏—Ö–∏—Ö —á–∞—Å–æ–≤
    timezone TEXT DEFAULT 'Asia/Yekaterinburg', -- –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å
    notify_on_check INTEGER DEFAULT 0,     -- –£–≤–µ–¥–æ–º–ª—è—Ç—å –æ –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**–°–≤—è–∑–∏:**
- `1:N` —Å `unified_routes` (–æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –º–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–æ–≤)
- `1:1` —Å `user_subscriptions` (–æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –æ–¥–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞)
- `1:1` —Å `user_stats` (–æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –æ–¥–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)
- `1:N` —Å `price_analytics` (–æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –º–Ω–æ–≥–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)
- `1:N` —Å `broadcast_log` (–æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –º–Ω–æ–≥–æ –ª–æ–≥–æ–≤ —Ä–∞—Å—Å—ã–ª–æ–∫) üì¢

***

### 2Ô∏è‚É£ **unified_routes** (–ú–∞—Ä—à—Ä—É—Ç—ã)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –•—Ä–∞–Ω–∏—Ç –≤—Å–µ –º–∞—Ä—à—Ä—É—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏ –≥–∏–±–∫–∏–µ)

```sql
CREATE TABLE unified_routes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    chat_id INTEGER NOT NULL,              -- FK ‚Üí user_settings

    -- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    origin TEXT NOT NULL,                  -- –ö–æ–¥ –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞ –≤—ã–ª–µ—Ç–∞ (IATA)
    destination TEXT NOT NULL,             -- –ö–æ–¥ –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞ –ø—Ä–∏–ª–µ—Ç–∞ (IATA)

    -- –¢–∏–ø –º–∞—Ä—à—Ä—É—Ç–∞
    is_flexible INTEGER DEFAULT 0,         -- 0 = —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, 1 = –≥–∏–±–∫–∏–π
    has_return INTEGER DEFAULT 1,          -- 0 = –≤ –æ–¥–Ω—É —Å—Ç–æ—Ä–æ–Ω—É, 1 = —Ç—É–¥–∞-–æ–±—Ä–∞—Ç–Ω–æ

    -- –î–õ–Ø –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–• –ú–ê–†–®–†–£–¢–û–í
    departure_date TEXT,                   -- –î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞ (YYYY-MM-DD)
    return_date TEXT,                      -- –î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ (YYYY-MM-DD)

    -- –î–õ–Ø –ì–ò–ë–ö–ò–• –ú–ê–†–®–†–£–¢–û–í
    departure_start TEXT,                  -- –ù–∞—á–∞–ª–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –≤—ã–ª–µ—Ç–∞
    departure_end TEXT,                    -- –ö–æ–Ω–µ—Ü –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –≤—ã–ª–µ—Ç–∞
    min_days INTEGER,                      -- –ú–∏–Ω–∏–º—É–º –¥–Ω–µ–π –≤ –ø–æ–µ–∑–¥–∫–µ
    max_days INTEGER,                      -- –ú–∞–∫—Å–∏–º—É–º –¥–Ω–µ–π –≤ –ø–æ–µ–∑–¥–∫–µ

    -- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞
    adults INTEGER DEFAULT 1,              -- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∑—Ä–æ—Å–ª—ã—Ö
    children INTEGER DEFAULT 0,            -- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–µ–π
    airline TEXT,                          -- –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º–∞—è –∞–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏—è ('any' = –ª—é–±–∞—è)
    baggage INTEGER DEFAULT 0,             -- 0 = —Ç–æ–ª—å–∫–æ —Ä—É—á–Ω–∞—è –∫–ª–∞–¥—å, 1 = 20–∫–≥
    max_stops INTEGER,                     -- –ú–∞–∫—Å–∏–º—É–º –ø–µ—Ä–µ—Å–∞–¥–æ–∫ (99 = –ª—é–±–æ–µ)
    max_layover_hours INTEGER,             -- –ú–∞–∫—Å–∏–º—É–º –≤—Ä–µ–º—è –ø–µ—Ä–µ—Å–∞–¥–∫–∏ (—á–∞—Å—ã)

    -- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    threshold_price REAL NOT NULL,         -- –ü–æ—Ä–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    currency TEXT DEFAULT 'RUB',           -- –í–∞–ª—é—Ç–∞

    -- –°–ª—É–∂–µ–±–Ω—ã–µ –ø–æ–ª—è
    is_paused INTEGER DEFAULT 0,           -- 0 = –∞–∫—Ç–∏–≤–µ–Ω, 1 = –Ω–∞ –ø–∞—É–∑–µ
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_check DATETIME,                   -- –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

    FOREIGN KEY (chat_id) REFERENCES user_settings(chat_id)
);
```

**–°–≤—è–∑–∏:**
- `N:1` —Å `user_settings` (–º–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–æ–≤ ‚Üí –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
- `1:N` —Å `route_results` (–æ–¥–∏–Ω –º–∞—Ä—à—Ä—É—Ç ‚Üí –º–Ω–æ–≥–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤)
- `1:N` —Å `route_check_stats` (–æ–¥–∏–Ω –º–∞—Ä—à—Ä—É—Ç ‚Üí –º–Ω–æ–≥–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫ –ø—Ä–æ–≤–µ—Ä–æ–∫)
- `1:N` —Å `combination_check_results` (–æ–¥–∏–Ω –º–∞—Ä—à—Ä—É—Ç ‚Üí –º–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–æ–∫)
- `1:N` —Å `price_analytics` (–æ–¥–∏–Ω –º–∞—Ä—à—Ä—É—Ç ‚Üí –º–Ω–æ–≥–æ –∑–∞–ø–∏—Å–µ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)

**–ò–Ω–¥–µ–∫—Å—ã:**
```sql
CREATE INDEX idx_unified_routes_chat_id ON unified_routes(chat_id);
```

***

### 3Ô∏è‚É£ **route_results** (–ù–∞–π–¥–µ–Ω–Ω—ã–µ –±–∏–ª–µ—Ç—ã)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –•—Ä–∞–Ω–∏—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –±–∏–ª–µ—Ç—ã (—Ü–µ–Ω–∞ ‚â§ –ø–æ—Ä–æ–≥–∞)

```sql
CREATE TABLE route_results (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    route_id INTEGER NOT NULL,             -- FK ‚Üí unified_routes

    departure_date TEXT NOT NULL,          -- –î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞
    return_date TEXT,                      -- –î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    days_in_country INTEGER,               -- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –≤ –ø–æ–µ–∑–¥–∫–µ

    total_price REAL NOT NULL,             -- –û–±—â–∞—è —Ü–µ–Ω–∞ –±–∏–ª–µ—Ç–∞
    airline TEXT NOT NULL,                 -- –ê–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏—è
    search_link TEXT NOT NULL,             -- –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–∏—Å–∫ Aviasales
    screenshot_path TEXT,                  -- –ü—É—Ç—å –∫ —Å–∫—Ä–∏–Ω—à–æ—Ç—É (–µ—Å–ª–∏ –µ—Å—Ç—å)

    found_at DATETIME DEFAULT CURRENT_TIMESTAMP, -- –ö–æ–≥–¥–∞ –Ω–∞–π–¥–µ–Ω

    FOREIGN KEY (route_id) REFERENCES unified_routes(id) ON DELETE CASCADE
);
```

**–°–≤—è–∑–∏:**
- `N:1` —Å `unified_routes` (–º–Ω–æ–≥–æ –±–∏–ª–µ—Ç–æ–≤ ‚Üí –æ–¥–∏–Ω –º–∞—Ä—à—Ä—É—Ç)

**–ò–Ω–¥–µ–∫—Å—ã:**
```sql
CREATE INDEX idx_route_results_route_id ON route_results(route_id);
CREATE INDEX idx_route_results_price ON route_results(route_id, total_price);
```

***

### 4Ô∏è‚É£ **route_check_stats** (–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ –º–∞—Ä—à—Ä—É—Ç–∞

```sql
CREATE TABLE route_check_stats (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    route_id INTEGER NOT NULL,             -- FK ‚Üí unified_routes
    check_timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,

    total_combinations INTEGER NOT NULL,   -- –í—Å–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
    successful_checks INTEGER NOT NULL,    -- –£—Å–ø–µ—à–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ (–Ω–∞–π–¥–µ–Ω—ã —Ü–µ–Ω—ã)
    failed_checks INTEGER NOT NULL,        -- –ù–µ—É–¥–∞—á–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ (–æ—à–∏–±–∫–∏/–Ω–µ –Ω–∞–π–¥–µ–Ω–æ)

    FOREIGN KEY (route_id) REFERENCES unified_routes(id) ON DELETE CASCADE
);
```

**–°–≤—è–∑–∏:**
- `N:1` —Å `unified_routes` (–º–Ω–æ–≥–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫ ‚Üí –æ–¥–∏–Ω –º–∞—Ä—à—Ä—É—Ç)

**–ò–Ω–¥–µ–∫—Å—ã:**
```sql
CREATE INDEX idx_route_check_stats_route_timestamp 
ON route_check_stats(route_id, check_timestamp DESC);
```

***

### 5Ô∏è‚É£ **combination_check_results** (–î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–æ–∫)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –¥–∞—Ç

```sql
CREATE TABLE combination_check_results (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    route_id INTEGER NOT NULL,             -- FK ‚Üí unified_routes
    check_timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,

    departure_date TEXT NOT NULL,          -- –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –¥–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞
    return_date TEXT,                      -- –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –¥–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞
    days_in_country INTEGER,               -- –î–Ω–µ–π –≤ –ø–æ–µ–∑–¥–∫–µ

    status TEXT NOT NULL,                  -- 'success', 'not_found', 'error'
    price REAL,                            -- –ù–∞–π–¥–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞ (–µ—Å–ª–∏ success)
    currency TEXT DEFAULT 'RUB',
    error_reason TEXT,                     -- –ü—Ä–∏—á–∏–Ω–∞ –æ—à–∏–±–∫–∏ (–µ—Å–ª–∏ error)
    search_url TEXT,                       -- URL –∑–∞–ø—Ä–æ—Å–∞

    FOREIGN KEY (route_id) REFERENCES unified_routes(id) ON DELETE CASCADE
);
```

**–°–≤—è–∑–∏:**
- `N:1` —Å `unified_routes` (–º–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ‚Üí –æ–¥–∏–Ω –º–∞—Ä—à—Ä—É—Ç)

**–ò–Ω–¥–µ–∫—Å—ã:**
```sql
CREATE INDEX idx_combination_check_route_timestamp 
ON combination_check_results(route_id, check_timestamp DESC);

CREATE INDEX idx_combination_check_status 
ON combination_check_results(route_id, status);
```

***

### 6Ô∏è‚É£ **price_analytics** (–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ü–µ–Ω)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ü–µ–Ω—ã –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤

```sql
CREATE TABLE price_analytics (
    id INTEGER PRIMARY KEY AUTOINCREMENT,

    -- –ü—Ä–∏–≤—è–∑–∫–∞
    route_type TEXT NOT NULL,              -- 'regular' –∏–ª–∏ 'flexible'
    origin TEXT NOT NULL,
    destination TEXT NOT NULL,
    route_id INTEGER,                      -- FK ‚Üí unified_routes (–º–æ–∂–µ—Ç –±—ã—Ç—å NULL)
    chat_id INTEGER,                       -- FK ‚Üí user_settings (–º–æ–∂–µ—Ç –±—ã—Ç—å NULL)

    -- –¶–µ–Ω–∞
    price REAL NOT NULL,
    airline TEXT,

    -- –í—Ä–µ–º—è
    found_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    hour_of_day INTEGER,                   -- –ß–∞—Å –¥–Ω—è (0-23)
    day_of_week INTEGER,                   -- –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (0-6, 0=–ü–Ω)
    day_of_month INTEGER,                  -- –î–µ–Ω—å –º–µ—Å—è—Ü–∞ (1-31)
    month INTEGER,                         -- –ú–µ—Å—è—Ü (1-12)
    year INTEGER,                          -- –ì–æ–¥
    is_weekend INTEGER,                    -- 0 = –±—É–¥–Ω–∏–π, 1 = –≤—ã—Ö–æ–¥–Ω–æ–π
    season TEXT                            -- 'winter', 'spring', 'summer', 'autumn'
);
```

**–°–≤—è–∑–∏:**
- `N:1` —Å `unified_routes` (–º–Ω–æ–≥–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ ‚Üí –æ–¥–∏–Ω –º–∞—Ä—à—Ä—É—Ç)
- `N:1` —Å `user_settings` (–º–Ω–æ–≥–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ ‚Üí –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

**–ò–Ω–¥–µ–∫—Å—ã:**
```sql
CREATE INDEX idx_price_analytics_route_id ON price_analytics(route_id);
CREATE INDEX idx_price_analytics_date ON price_analytics(found_at);
CREATE INDEX idx_price_analytics_route ON price_analytics(origin, destination, route_id);
CREATE INDEX idx_price_analytics_time ON price_analytics(hour_of_day, day_of_week);
CREATE INDEX idx_price_analytics_chat ON price_analytics(chat_id);
```

***

### 7Ô∏è‚É£ **user_subscriptions** (–ü–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–ø–∏—Å–∫–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```sql
CREATE TABLE user_subscriptions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    chat_id INTEGER NOT NULL UNIQUE,       -- FK ‚Üí user_settings
    subscription_type TEXT NOT NULL DEFAULT 'free', -- FK ‚Üí subscription_types

    valid_from DATETIME DEFAULT CURRENT_TIMESTAMP,
    valid_to DATETIME,                     -- NULL –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
    is_active INTEGER DEFAULT 1,           -- 0 = –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞, 1 = –∞–∫—Ç–∏–≤–Ω–∞
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (chat_id) REFERENCES user_settings(chat_id)
);
```

**–°–≤—è–∑–∏:**
- `1:1` —Å `user_settings` (–æ–¥–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞ ‚Üí –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
- `N:1` —Å `subscription_types` (–º–Ω–æ–≥–æ –ø–æ–¥–ø–∏—Å–æ–∫ ‚Üí –æ–¥–∏–Ω —Ç–∏–ø)

**–ò–Ω–¥–µ–∫—Å—ã:**
```sql
CREATE INDEX idx_user_subscriptions_chat_id ON user_subscriptions(chat_id);
CREATE INDEX idx_user_subscriptions_valid_to ON user_subscriptions(valid_to);
CREATE INDEX idx_user_subscriptions_type ON user_subscriptions(subscription_type);
```

***

### 8Ô∏è‚É£ **subscription_types** (–¢–∏–ø—ã –ø–æ–¥–ø–∏—Å–æ–∫)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∏–ø—ã –ø–æ–¥–ø–∏—Å–æ–∫ –∏ –∏—Ö –ª–∏–º–∏—Ç—ã

```sql
CREATE TABLE subscription_types (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,             -- 'free', 'plus', 'admin'
    display_name TEXT NOT NULL,            -- –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ

    max_fixed_routes INTEGER NOT NULL,     -- –ú–∞–∫—Å. —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
    max_flexible_routes INTEGER NOT NULL,  -- –ú–∞–∫—Å. –≥–∏–±–∫–∏—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
    max_combinations INTEGER NOT NULL,     -- –ú–∞–∫—Å. –∫–æ–º–±–∏–Ω–∞—Ü–∏–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    check_interval_hours INTEGER NOT NULL, -- –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–æ–∫ (—á–∞—Å—ã)

    price_per_month REAL DEFAULT 0,        -- –¶–µ–Ω–∞ –≤ –º–µ—Å—è—Ü
    is_active INTEGER DEFAULT 1,           -- –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- –ë–∞–∑–æ–≤—ã–µ —Ç–∏–ø—ã
INSERT INTO subscription_types 
(name, display_name, max_fixed_routes, max_flexible_routes, max_combinations, check_interval_hours, price_per_month)
VALUES
('free', '–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è', 3, 1, 20, 4, 0),
('plus', 'Plus', 5, 3, 50, 2, 199),
('admin', 'Admin', 999, 999, 999, 1, 0);
```

**–°–≤—è–∑–∏:**
- `1:N` —Å `user_subscriptions` (–æ–¥–∏–Ω —Ç–∏–ø ‚Üí –º–Ω–æ–≥–æ –ø–æ–¥–ø–∏—Å–æ–∫)

***

### 9Ô∏è‚É£ **user_stats** (–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

```sql
CREATE TABLE user_stats (
    chat_id INTEGER PRIMARY KEY,           -- FK ‚Üí user_settings
    total_routes INTEGER DEFAULT 0,        -- –í—Å–µ–≥–æ –º–∞—Ä—à—Ä—É—Ç–æ–≤
    total_alerts INTEGER DEFAULT 0,        -- –í—Å–µ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
    total_savings REAL DEFAULT 0,          -- –û–±—â–∞—è —ç–∫–æ–Ω–æ–º–∏—è
    total_checks INTEGER DEFAULT 0,        -- –í—Å–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
    last_check DATETIME,                   -- –ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

***

### üîü **notification_cooldown** (–¢–∞–π–º–∞—É—Ç—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∞–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

```sql
CREATE TABLE notification_cooldown (
    chat_id INTEGER PRIMARY KEY,
    last_notification INTEGER NOT NULL     -- Unix timestamp
);
```

***

### 1Ô∏è‚É£1Ô∏è‚É£ **üì¢ broadcasts** (–ú–∞—Å—Å–æ–≤—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏) - –ù–û–í–û–ï

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—Å—Å–æ–≤—ã—Ö —Ä–∞—Å—Å—ã–ª–∫–∞—Ö

```sql
CREATE TABLE broadcasts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    message_text TEXT NOT NULL,            -- –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (Markdown)
    target_users TEXT NOT NULL DEFAULT 'all', -- 'all' –∏–ª–∏ JSON –º–∞—Å—Å–∏–≤ chat_id
    scheduled_time TEXT NOT NULL,          -- –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (HH:MM)

    -- –°—Ç–∞—Ç—É—Å
    is_sent INTEGER DEFAULT 0,             -- 0 = –≤ –æ—á–µ—Ä–µ–¥–∏, 1 = –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
    total_users INTEGER DEFAULT 0,         -- –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    sent_count INTEGER DEFAULT 0,          -- –£–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ

    -- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    sent_at DATETIME                       -- –ö–æ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞
);
```

**–°–≤—è–∑–∏:**
- `1:N` —Å `broadcast_log` (–æ–¥–Ω–∞ —Ä–∞—Å—Å—ã–ª–∫–∞ ‚Üí –º–Ω–æ–≥–æ –ª–æ–≥–æ–≤ –æ—Ç–ø—Ä–∞–≤–∫–∏)

**–ò–Ω–¥–µ–∫—Å—ã:**
```sql
CREATE INDEX idx_broadcasts_is_sent ON broadcasts(is_sent);
CREATE INDEX idx_broadcasts_scheduled ON broadcasts(scheduled_time);
CREATE INDEX idx_broadcasts_created ON broadcasts(created_at DESC);
```

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```sql
-- –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏ (–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ)
SELECT * FROM broadcasts
WHERE is_sent = 0
ORDER BY created_at DESC;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å—Å—ã–ª–æ–∫
SELECT 
    id,
    message_text,
    total_users,
    sent_count,
    ROUND(sent_count * 100.0 / total_users, 2) as progress,
    is_sent,
    created_at,
    sent_at
FROM broadcasts
ORDER BY created_at DESC
LIMIT 10;
```

***

### 1Ô∏è‚É£2Ô∏è‚É£ **üì¢ broadcast_log** (–õ–æ–≥–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–æ–∫) - –ù–û–í–û–ï

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –õ–æ–≥–∏—Ä—É–µ—Ç –∫–∞–∂–¥—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ä–∞–º–∫–∞—Ö —Ä–∞—Å—Å—ã–ª–∫–∏

```sql
CREATE TABLE broadcast_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    broadcast_id INTEGER NOT NULL,         -- FK ‚Üí broadcasts
    chat_id INTEGER NOT NULL,              -- FK ‚Üí user_settings

    -- –°—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏
    status TEXT NOT NULL,                  -- 'success', 'error', 'skipped'
    error_message TEXT,                    -- –¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)

    -- –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞
    sent_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (broadcast_id) REFERENCES broadcasts(id) ON DELETE CASCADE,
    FOREIGN KEY (chat_id) REFERENCES user_settings(chat_id) ON DELETE CASCADE
);
```

**–°–≤—è–∑–∏:**
- `N:1` —Å `broadcasts` (–º–Ω–æ–≥–æ –ª–æ–≥–æ–≤ ‚Üí –æ–¥–Ω–∞ —Ä–∞—Å—Å—ã–ª–∫–∞)
- `N:1` —Å `user_settings` (–º–Ω–æ–≥–æ –ª–æ–≥–æ–≤ ‚Üí –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

**–ò–Ω–¥–µ–∫—Å—ã:**
```sql
CREATE INDEX idx_broadcast_log_broadcast_id ON broadcast_log(broadcast_id);
CREATE INDEX idx_broadcast_log_chat_id ON broadcast_log(chat_id);
CREATE INDEX idx_broadcast_log_status ON broadcast_log(status);
CREATE INDEX idx_broadcast_log_sent_at ON broadcast_log(sent_at DESC);
```

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```sql
-- –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–æ–∫ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏
SELECT 
    bl.id,
    bl.chat_id,
    us.timezone,
    bl.status,
    bl.error_message,
    bl.sent_at
FROM broadcast_log bl
LEFT JOIN user_settings us ON bl.chat_id = us.chat_id
WHERE bl.broadcast_id = ?
ORDER BY bl.sent_at ASC;

-- –û—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
SELECT 
    bl.*,
    b.message_text,
    us.timezone
FROM broadcast_log bl
JOIN broadcasts b ON bl.broadcast_id = b.id
LEFT JOIN user_settings us ON bl.chat_id = us.chat_id
WHERE bl.status = 'error'
ORDER BY bl.sent_at DESC
LIMIT 100;
```

***

## üîç –ü–†–ò–ú–ï–†–´ –ó–ê–ü–†–û–°–û–í

### üìå –ü–æ–ª—É—á–∏—Ç—å –ª—É—á—à–∏–µ —Ü–µ–Ω—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –º–∞—Ä—à—Ä—É—Ç—É

```sql
-- –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ route_results (–Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –±–∏–ª–µ—Ç—ã)
SELECT 
    rr.id,
    rr.departure_date,
    rr.return_date,
    rr.total_price,
    rr.airline,
    rr.search_link,
    rr.found_at,
    ur.origin,
    ur.destination,
    ur.threshold_price
FROM route_results rr
JOIN unified_routes ur ON rr.route_id = ur.id
WHERE ur.chat_id = ?           -- ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  AND ur.id = ?                -- ID –º–∞—Ä—à—Ä—É—Ç–∞
ORDER BY rr.total_price ASC
LIMIT 10;

-- –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ price_analytics (–≤—Å—è –∏—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω)
SELECT 
    pa.price,
    pa.airline,
    pa.found_at,
    ur.origin,
    ur.destination
FROM price_analytics pa
JOIN unified_routes ur ON pa.route_id = ur.id
WHERE ur.chat_id = ?
  AND ur.id = ?
ORDER BY pa.price ASC, pa.found_at DESC
LIMIT 10;
```

***

### üìå –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –º–∞—Ä—à—Ä—É—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤

```sql
SELECT 
    ur.*,
    COUNT(DISTINCT rr.id) as total_results,
    MIN(rr.total_price) as best_price,
    (SELECT COUNT(*) FROM route_check_stats WHERE route_id = ur.id) as check_count
FROM unified_routes ur
LEFT JOIN route_results rr ON ur.id = rr.route_id
WHERE ur.chat_id = ?
GROUP BY ur.id
ORDER BY ur.created_at DESC;
```

***

### üìå –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ (—Å timezone)

```sql
-- –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –º–∞—Ä—à—Ä—É—Ç–∞–º–∏
SELECT DISTINCT
    us.chat_id,
    us.timezone,
    COUNT(DISTINCT ur.id) as routes_count
FROM user_settings us
LEFT JOIN unified_routes ur ON us.chat_id = ur.chat_id
GROUP BY us.chat_id
HAVING routes_count > 0
ORDER BY us.created_at DESC;

-- –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)
SELECT DISTINCT
    us.chat_id,
    us.timezone,
    MAX(ur.last_check) as last_active
FROM user_settings us
JOIN unified_routes ur ON us.chat_id = ur.chat_id
WHERE ur.last_check >= datetime('now', '-7 days')
GROUP BY us.chat_id
ORDER BY last_active DESC;
```

***

### üìå –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞—Å—Å—ã–ª–∫–µ

```sql
-- –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞—Å—Å—ã–ª–∫–µ —Å –ª–æ–≥–∞–º–∏
SELECT 
    b.id,
    b.message_text,
    b.scheduled_time,
    b.is_sent,
    b.total_users,
    b.sent_count,
    b.created_at,
    b.sent_at,
    COUNT(CASE WHEN bl.status = 'success' THEN 1 END) as success_count,
    COUNT(CASE WHEN bl.status = 'error' THEN 1 END) as error_count,
    COUNT(CASE WHEN bl.status = 'skipped' THEN 1 END) as skipped_count
FROM broadcasts b
LEFT JOIN broadcast_log bl ON b.id = bl.broadcast_id
WHERE b.id = ?
GROUP BY b.id;

-- –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–æ–º—É —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
SELECT 
    bl.chat_id,
    us.timezone,
    bl.sent_at,
    bl.status
FROM broadcast_log bl
LEFT JOIN user_settings us ON bl.chat_id = us.chat_id
WHERE bl.broadcast_id = ?
  AND bl.status = 'success'
ORDER BY bl.sent_at ASC;
```

***

### üìå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è

```sql
-- –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —É –∫–æ—Ç–æ—Ä—ã—Ö —Å–µ–π—á–∞—Å 10:00 –ø–æ –∏—Ö –ª–æ–∫–∞–ª—å–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏
-- (–¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ —Ä–∞—Å—Å—ã–ª–æ–∫)
WITH target_time AS (
    SELECT '10:00' as scheduled_time
)
SELECT 
    us.chat_id,
    us.timezone,
    strftime('%H:%M', datetime('now', 'localtime')) as server_time,
    -- –í—ã—á–∏—Å–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    strftime('%H:%M', 
        datetime('now', 'utc', 
            CASE us.timezone
                WHEN 'Europe/Moscow' THEN '+3 hours'
                WHEN 'Asia/Yekaterinburg' THEN '+5 hours'
                WHEN 'Asia/Vladivostok' THEN '+10 hours'
                -- –¥–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–∞–π–º–∑–æ–Ω—ã
                ELSE '+0 hours'
            END
        )
    ) as user_local_time
FROM user_settings us
WHERE user_local_time = (SELECT scheduled_time FROM target_time);
```

***

## üéØ –ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ò–ú–ï–†–´

### –ü—Ä–∏–º–µ—Ä 1: –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ –º–∞—Ä—à—Ä—É—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```sql
-- –ú–∞—Ä—à—Ä—É—Ç + –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è + –ø–æ–¥–ø–∏—Å–∫–∞ + —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
SELECT 
    ur.*,
    us.timezone,
    us.quiet_hours_start,
    us.quiet_hours_end,
    usub.subscription_type,
    (SELECT COUNT(*) FROM route_results WHERE route_id = ur.id) as total_results,
    (SELECT MIN(total_price) FROM route_results WHERE route_id = ur.id) as best_price,
    (SELECT COUNT(*) FROM route_check_stats WHERE route_id = ur.id) as total_checks
FROM unified_routes ur
JOIN user_settings us ON ur.chat_id = us.chat_id
LEFT JOIN user_subscriptions usub ON ur.chat_id = usub.chat_id
WHERE ur.id = ?;
```

***

### –ü—Ä–∏–º–µ—Ä 2: –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```sql
-- –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
INSERT INTO broadcasts (message_text, target_users, scheduled_time, total_users)
VALUES (
    'üéâ –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å –±–∏–ª–µ—Ç—ã —Å –≥–∏–±–∫–∏–º–∏ –¥–∞—Ç–∞–º–∏.',
    'all',
    '10:00',
    (SELECT COUNT(*) FROM user_settings)
);

-- –®–∞–≥ 2: –ü–æ–ª—É—á–∏—Ç—å ID —Å–æ–∑–¥–∞–Ω–Ω–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏
SELECT last_insert_rowid() as broadcast_id;

-- –®–∞–≥ 3: –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–∞–∂–¥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é - –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥
INSERT INTO broadcast_log (broadcast_id, chat_id, status)
VALUES (1, 123456789, 'success');

-- –®–∞–≥ 4: –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö
UPDATE broadcasts
SET sent_count = sent_count + 1
WHERE id = 1;

-- –®–∞–≥ 5: –ö–æ–≥–¥–∞ –≤—Å–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ - –ø–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—É—é
UPDATE broadcasts
SET is_sent = 1, sent_at = CURRENT_TIMESTAMP
WHERE id = 1 AND sent_count >= total_users;
```

***

### –ü—Ä–∏–º–µ—Ä 3: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å—Å—ã–ª–æ–∫

```sql
-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º —Ä–∞—Å—Å—ã–ª–∫–∞–º
SELECT 
    COUNT(*) as total_broadcasts,
    SUM(CASE WHEN is_sent = 1 THEN 1 ELSE 0 END) as sent,
    SUM(CASE WHEN is_sent = 0 THEN 1 ELSE 0 END) as pending,
    SUM(total_users) as total_messages,
    SUM(sent_count) as actually_sent,
    AVG(sent_count * 100.0 / NULLIF(total_users, 0)) as avg_success_rate
FROM broadcasts;

-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Ä–∞—Å—Å—ã–ª–æ–∫ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
SELECT 
    b.id,
    SUBSTR(b.message_text, 1, 50) || '...' as preview,
    b.scheduled_time,
    b.total_users,
    b.sent_count,
    ROUND(b.sent_count * 100.0 / NULLIF(b.total_users, 0), 2) || '%' as success_rate,
    b.is_sent,
    b.created_at,
    COALESCE(
        (SELECT COUNT(*) FROM broadcast_log WHERE broadcast_id = b.id AND status = 'error'),
        0
    ) as errors
FROM broadcasts b
ORDER BY b.created_at DESC
LIMIT 10;
```

***

## üìñ –í–´–í–û–î–´

### –û—Å–Ω–æ–≤–Ω—ã–µ —Å–≤—è–∑–∏:

1. **user_settings** ‚Äî –∫–æ—Ä–Ω–µ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. **unified_routes** ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞, —Å–≤—è–∑—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
3. **route_results** ‚Äî –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –±–∏–ª–µ—Ç—ã (—Ü–µ–Ω–∞ ‚â§ –ø–æ—Ä–æ–≥–∞)
4. **price_analytics** ‚Äî –≤—Å—è –∏—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
5. **route_check_stats** ‚Äî –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫
6. **combination_check_results** ‚Äî –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
7. **üì¢ broadcasts** ‚Äî –º–∞—Å—Å–æ–≤—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏ (–Ω–æ–≤–æ–µ)
8. **üì¢ broadcast_log** ‚Äî –ª–æ–≥–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–æ–∫ (–Ω–æ–≤–æ–µ)

### –ö–ª—é—á–µ–≤—ã–µ Foreign Keys:

- `unified_routes.chat_id` ‚Üí `user_settings.chat_id`
- `route_results.route_id` ‚Üí `unified_routes.id`
- `route_check_stats.route_id` ‚Üí `unified_routes.id`
- `combination_check_results.route_id` ‚Üí `unified_routes.id`
- `price_analytics.route_id` ‚Üí `unified_routes.id`
- `price_analytics.chat_id` ‚Üí `user_settings.chat_id`
- `user_subscriptions.chat_id` ‚Üí `user_settings.chat_id`
- **`broadcast_log.broadcast_id` ‚Üí `broadcasts.id`** üì¢
- **`broadcast_log.chat_id` ‚Üí `user_settings.chat_id`** üì¢

### –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å - –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞:

- –¢–∞–±–ª–∏—Ü–∞ `broadcasts` —Ö—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞—Å—Å—ã–ª–∫–∞—Ö
- –¢–∞–±–ª–∏—Ü–∞ `broadcast_log` –ª–æ–≥–∏—Ä—É–µ—Ç –∫–∞–∂–¥—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ –ª–æ–∫–∞–ª—å–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ rate limits Telegram (25 —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫)
- –ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

–¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å –ø–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö! üéâ

---

*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 03.02.2026*  
*–í–µ—Ä—Å–∏—è –ë–î: 2.0* - –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏
