–í–æ—Ç –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ —Å–≤—è–∑—è–º –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏:

***

# üìä –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø: –°–¢–†–£–ö–¢–£–†–ê –ë–ê–ó–´ –î–ê–ù–ù–´–•

## üóÇÔ∏è –û–±–∑–æ—Ä —Ç–∞–±–ª–∏—Ü

–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–¥–µ—Ä–∂–∏—Ç **10 –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü**:

1. **user_settings** - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. **unified_routes** - –º–∞—Ä—à—Ä—É—Ç—ã (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏ –≥–∏–±–∫–∏–µ)
3. **route_results** - –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –±–∏–ª–µ—Ç—ã
4. **route_check_stats** - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫
5. **combination_check_results** - –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–æ–∫
6. **price_analytics** - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ü–µ–Ω
7. **user_stats** - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
8. **user_subscriptions** - –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
9. **subscription_types** - —Ç–∏–ø—ã –ø–æ–¥–ø–∏—Å–æ–∫
10. **notification_cooldown** - —Ç–∞–π–º–∞—É—Ç—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

***

## üîó –î–ò–ê–ì–†–ê–ú–ú–ê –°–í–Ø–ó–ï–ô

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   user_settings     ‚îÇ
‚îÇ  (chat_id - PK)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ 1
           ‚îÇ
           ‚îÇ N
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  unified_routes     ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  (id - PK)          ‚îÇ                     ‚îÇ
‚îÇ  (chat_id - FK)     ‚îÇ                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                     ‚îÇ
           ‚îÇ 1                              ‚îÇ
           ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
           ‚îÇ N        ‚îÇ N       ‚îÇ N         ‚îÇ N
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ route_results  ‚îÇ ‚îÇroute_  ‚îÇ ‚îÇcombination‚îÇ ‚îÇ price_analytics   ‚îÇ
‚îÇ (route_id-FK)  ‚îÇ ‚îÇcheck_  ‚îÇ ‚îÇ_check_    ‚îÇ ‚îÇ (route_id - FK)   ‚îÇ
‚îÇ                ‚îÇ ‚îÇstats   ‚îÇ ‚îÇresults    ‚îÇ ‚îÇ (chat_id - FK)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ(FK)    ‚îÇ ‚îÇ(FK)       ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ user_subscriptions  ‚îÇ    N:1  ‚îÇ subscription_types  ‚îÇ
‚îÇ (chat_id - FK)      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ (name - PK)         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ notification_       ‚îÇ
‚îÇ cooldown            ‚îÇ
‚îÇ (chat_id - PK)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   user_stats        ‚îÇ
‚îÇ (chat_id - PK)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

***

## üìã –î–ï–¢–ê–õ–¨–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï –¢–ê–ë–õ–ò–¶

### 1Ô∏è‚É£ **user_settings** (–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –•—Ä–∞–Ω–∏—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–æ—Ç–∞

```sql
CREATE TABLE user_settings (
    chat_id INTEGER PRIMARY KEY,           -- Telegram chat ID
    quiet_hours_start INTEGER DEFAULT 23,  -- –ù–∞—á–∞–ª–æ —Ç–∏—Ö–∏—Ö —á–∞—Å–æ–≤
    quiet_hours_end INTEGER DEFAULT 7,     -- –ö–æ–Ω–µ—Ü —Ç–∏—Ö–∏—Ö —á–∞—Å–æ–≤
    timezone TEXT DEFAULT 'Asia/Yekaterinburg', -- –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å
    notify_on_check INTEGER DEFAULT 0,     -- –£–≤–µ–¥–æ–º–ª—è—Ç—å –æ –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**–°–≤—è–∑–∏:**
- `1:N` —Å `unified_routes` (–æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –º–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–æ–≤)
- `1:1` —Å `user_subscriptions` (–æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –æ–¥–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞)
- `1:1` —Å `user_stats` (–æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –æ–¥–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)
- `1:N` —Å `price_analytics` (–æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –º–Ω–æ–≥–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)

***

### 2Ô∏è‚É£ **unified_routes** (–ú–∞—Ä—à—Ä—É—Ç—ã)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –•—Ä–∞–Ω–∏—Ç –≤—Å–µ –º–∞—Ä—à—Ä—É—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏ –≥–∏–±–∫–∏–µ)

```sql
CREATE TABLE unified_routes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    chat_id INTEGER NOT NULL,              -- FK ‚Üí user_settings
    
    -- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    origin TEXT NOT NULL,                  -- –ö–æ–¥ –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞ –≤—ã–ª–µ—Ç–∞ (IATA)
    destination TEXT NOT NULL,             -- –ö–æ–¥ –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞ –ø—Ä–∏–ª–µ—Ç–∞ (IATA)
    
    -- –¢–∏–ø –º–∞—Ä—à—Ä—É—Ç–∞
    is_flexible INTEGER DEFAULT 0,         -- 0 = —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, 1 = –≥–∏–±–∫–∏–π
    has_return INTEGER DEFAULT 1,          -- 0 = –≤ –æ–¥–Ω—É —Å—Ç–æ—Ä–æ–Ω—É, 1 = —Ç—É–¥–∞-–æ–±—Ä–∞—Ç–Ω–æ
    
    -- –î–õ–Ø –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–• –ú–ê–†–®–†–£–¢–û–í
    departure_date TEXT,                   -- –î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞ (YYYY-MM-DD)
    return_date TEXT,                      -- –î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ (YYYY-MM-DD)
    
    -- –î–õ–Ø –ì–ò–ë–ö–ò–• –ú–ê–†–®–†–£–¢–û–í
    departure_start TEXT,                  -- –ù–∞—á–∞–ª–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –≤—ã–ª–µ—Ç–∞
    departure_end TEXT,                    -- –ö–æ–Ω–µ—Ü –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –≤—ã–ª–µ—Ç–∞
    min_days INTEGER,                      -- –ú–∏–Ω–∏–º—É–º –¥–Ω–µ–π –≤ –ø–æ–µ–∑–¥–∫–µ
    max_days INTEGER,                      -- –ú–∞–∫—Å–∏–º—É–º –¥–Ω–µ–π –≤ –ø–æ–µ–∑–¥–∫–µ
    
    -- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞
    adults INTEGER DEFAULT 1,              -- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∑—Ä–æ—Å–ª—ã—Ö
    children INTEGER DEFAULT 0,            -- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–µ–π
    airline TEXT,                          -- –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º–∞—è –∞–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏—è ('any' = –ª—é–±–∞—è)
    baggage INTEGER DEFAULT 0,             -- 0 = —Ç–æ–ª—å–∫–æ —Ä—É—á–Ω–∞—è –∫–ª–∞–¥—å, 1 = 20–∫–≥
    max_stops INTEGER,                     -- –ú–∞–∫—Å–∏–º—É–º –ø–µ—Ä–µ—Å–∞–¥–æ–∫ (99 = –ª—é–±–æ–µ)
    max_layover_hours INTEGER,             -- –ú–∞–∫—Å–∏–º—É–º –≤—Ä–µ–º—è –ø–µ—Ä–µ—Å–∞–¥–∫–∏ (—á–∞—Å—ã)
    
    -- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    threshold_price REAL NOT NULL,         -- –ü–æ—Ä–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    currency TEXT DEFAULT 'RUB',           -- –í–∞–ª—é—Ç–∞
    
    -- –°–ª—É–∂–µ–±–Ω—ã–µ –ø–æ–ª—è
    is_paused INTEGER DEFAULT 0,           -- 0 = –∞–∫—Ç–∏–≤–µ–Ω, 1 = –Ω–∞ –ø–∞—É–∑–µ
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_check DATETIME,                   -- –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
    
    FOREIGN KEY (chat_id) REFERENCES user_settings(chat_id)
);
```

**–°–≤—è–∑–∏:**
- `N:1` —Å `user_settings` (–º–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–æ–≤ ‚Üí –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
- `1:N` —Å `route_results` (–æ–¥–∏–Ω –º–∞—Ä—à—Ä—É—Ç ‚Üí –º–Ω–æ–≥–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤)
- `1:N` —Å `route_check_stats` (–æ–¥–∏–Ω –º–∞—Ä—à—Ä—É—Ç ‚Üí –º–Ω–æ–≥–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫ –ø—Ä–æ–≤–µ—Ä–æ–∫)
- `1:N` —Å `combination_check_results` (–æ–¥–∏–Ω –º–∞—Ä—à—Ä—É—Ç ‚Üí –º–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–æ–∫)
- `1:N` —Å `price_analytics` (–æ–¥–∏–Ω –º–∞—Ä—à—Ä—É—Ç ‚Üí –º–Ω–æ–≥–æ –∑–∞–ø–∏—Å–µ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)

**–ò–Ω–¥–µ–∫—Å—ã:**
```sql
CREATE INDEX idx_unified_routes_chat_id ON unified_routes(chat_id);
```

***

### 3Ô∏è‚É£ **route_results** (–ù–∞–π–¥–µ–Ω–Ω—ã–µ –±–∏–ª–µ—Ç—ã)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –•—Ä–∞–Ω–∏—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –±–∏–ª–µ—Ç—ã (—Ü–µ–Ω–∞ ‚â§ –ø–æ—Ä–æ–≥–∞)

```sql
CREATE TABLE route_results (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    route_id INTEGER NOT NULL,             -- FK ‚Üí unified_routes
    
    departure_date TEXT NOT NULL,          -- –î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞
    return_date TEXT,                      -- –î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    days_in_country INTEGER,               -- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –≤ –ø–æ–µ–∑–¥–∫–µ
    
    total_price REAL NOT NULL,             -- –û–±—â–∞—è —Ü–µ–Ω–∞ –±–∏–ª–µ—Ç–∞
    airline TEXT NOT NULL,                 -- –ê–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏—è
    search_link TEXT NOT NULL,             -- –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–∏—Å–∫ Aviasales
    screenshot_path TEXT,                  -- –ü—É—Ç—å –∫ —Å–∫—Ä–∏–Ω—à–æ—Ç—É (–µ—Å–ª–∏ –µ—Å—Ç—å)
    
    found_at DATETIME DEFAULT CURRENT_TIMESTAMP, -- –ö–æ–≥–¥–∞ –Ω–∞–π–¥–µ–Ω
    
    FOREIGN KEY (route_id) REFERENCES unified_routes(id) ON DELETE CASCADE
);
```

**–°–≤—è–∑–∏:**
- `N:1` —Å `unified_routes` (–º–Ω–æ–≥–æ –±–∏–ª–µ—Ç–æ–≤ ‚Üí –æ–¥–∏–Ω –º–∞—Ä—à—Ä—É—Ç)

**–ò–Ω–¥–µ–∫—Å—ã:**
```sql
CREATE INDEX idx_route_results_route_id ON route_results(route_id);
CREATE INDEX idx_route_results_price ON route_results(route_id, total_price);
```

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```sql
-- –ü–æ–ª—É—á–∏—Ç—å –ª—É—á—à–∏–µ –±–∏–ª–µ—Ç—ã –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞
SELECT * FROM route_results
WHERE route_id = ?
ORDER BY total_price ASC
LIMIT 10;
```

***

### 4Ô∏è‚É£ **route_check_stats** (–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ –º–∞—Ä—à—Ä—É—Ç–∞

```sql
CREATE TABLE route_check_stats (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    route_id INTEGER NOT NULL,             -- FK ‚Üí unified_routes
    check_timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    total_combinations INTEGER NOT NULL,   -- –í—Å–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
    successful_checks INTEGER NOT NULL,    -- –£—Å–ø–µ—à–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ (–Ω–∞–π–¥–µ–Ω—ã —Ü–µ–Ω—ã)
    failed_checks INTEGER NOT NULL,        -- –ù–µ—É–¥–∞—á–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ (–æ—à–∏–±–∫–∏/–Ω–µ –Ω–∞–π–¥–µ–Ω–æ)
    
    FOREIGN KEY (route_id) REFERENCES unified_routes(id) ON DELETE CASCADE
);
```

**–°–≤—è–∑–∏:**
- `N:1` —Å `unified_routes` (–º–Ω–æ–≥–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫ ‚Üí –æ–¥–∏–Ω –º–∞—Ä—à—Ä—É—Ç)

**–ò–Ω–¥–µ–∫—Å—ã:**
```sql
CREATE INDEX idx_route_check_stats_route_timestamp 
ON route_check_stats(route_id, check_timestamp DESC);
```

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```sql
-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
SELECT 
    cs.*,
    (r.origin || ' ‚Üí ' || r.destination) as route_name,
    r.chat_id
FROM route_check_stats cs
JOIN unified_routes r ON cs.route_id = r.id
WHERE cs.check_timestamp >= datetime('now', '-1 day')
ORDER BY cs.check_timestamp DESC;
```

***

### 5Ô∏è‚É£ **combination_check_results** (–î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–æ–∫)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –¥–∞—Ç

```sql
CREATE TABLE combination_check_results (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    route_id INTEGER NOT NULL,             -- FK ‚Üí unified_routes
    check_timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    departure_date TEXT NOT NULL,          -- –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –¥–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞
    return_date TEXT,                      -- –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –¥–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞
    days_in_country INTEGER,               -- –î–Ω–µ–π –≤ –ø–æ–µ–∑–¥–∫–µ
    
    status TEXT NOT NULL,                  -- 'success', 'not_found', 'error'
    price REAL,                            -- –ù–∞–π–¥–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞ (–µ—Å–ª–∏ success)
    currency TEXT DEFAULT 'RUB',
    error_reason TEXT,                     -- –ü—Ä–∏—á–∏–Ω–∞ –æ—à–∏–±–∫–∏ (–µ—Å–ª–∏ error)
    search_url TEXT,                       -- URL –∑–∞–ø—Ä–æ—Å–∞
    
    FOREIGN KEY (route_id) REFERENCES unified_routes(id) ON DELETE CASCADE
);
```

**–°–≤—è–∑–∏:**
- `N:1` —Å `unified_routes` (–º–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ‚Üí –æ–¥–∏–Ω –º–∞—Ä—à—Ä—É—Ç)

**–ò–Ω–¥–µ–∫—Å—ã:**
```sql
CREATE INDEX idx_combination_check_route_timestamp 
ON combination_check_results(route_id, check_timestamp DESC);

CREATE INDEX idx_combination_check_status 
ON combination_check_results(route_id, status);
```

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```sql
-- –í—Å–µ –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
SELECT 
    ccr.*,
    (r.origin || ' ‚Üí ' || r.destination) as route_name,
    r.chat_id
FROM combination_check_results ccr
JOIN unified_routes r ON ccr.route_id = r.id
WHERE ccr.status IN ('error', 'not_found')
ORDER BY ccr.check_timestamp DESC
LIMIT 100;
```

***

### 6Ô∏è‚É£ **price_analytics** (–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ü–µ–Ω)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ü–µ–Ω—ã –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤

```sql
CREATE TABLE price_analytics (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    
    -- –ü—Ä–∏–≤—è–∑–∫–∞
    route_type TEXT NOT NULL,              -- 'regular' –∏–ª–∏ 'flexible'
    origin TEXT NOT NULL,
    destination TEXT NOT NULL,
    route_id INTEGER,                      -- FK ‚Üí unified_routes (–º–æ–∂–µ—Ç –±—ã—Ç—å NULL)
    chat_id INTEGER,                       -- FK ‚Üí user_settings (–º–æ–∂–µ—Ç –±—ã—Ç—å NULL)
    
    -- –¶–µ–Ω–∞
    price REAL NOT NULL,
    airline TEXT,
    
    -- –í—Ä–µ–º—è
    found_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    hour_of_day INTEGER,                   -- –ß–∞—Å –¥–Ω—è (0-23)
    day_of_week INTEGER,                   -- –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (0-6, 0=–ü–Ω)
    day_of_month INTEGER,                  -- –î–µ–Ω—å –º–µ—Å—è—Ü–∞ (1-31)
    month INTEGER,                         -- –ú–µ—Å—è—Ü (1-12)
    year INTEGER,                          -- –ì–æ–¥
    is_weekend INTEGER,                    -- 0 = –±—É–¥–Ω–∏–π, 1 = –≤—ã—Ö–æ–¥–Ω–æ–π
    season TEXT                            -- 'winter', 'spring', 'summer', 'autumn'
);
```

**–°–≤—è–∑–∏:**
- `N:1` —Å `unified_routes` (–º–Ω–æ–≥–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ ‚Üí –æ–¥–∏–Ω –º–∞—Ä—à—Ä—É—Ç)
- `N:1` —Å `user_settings` (–º–Ω–æ–≥–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ ‚Üí –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

**–ò–Ω–¥–µ–∫—Å—ã:**
```sql
CREATE INDEX idx_price_analytics_route_id ON price_analytics(route_id);
CREATE INDEX idx_price_analytics_date ON price_analytics(found_at);
CREATE INDEX idx_price_analytics_route ON price_analytics(origin, destination, route_id);
CREATE INDEX idx_price_analytics_time ON price_analytics(hour_of_day, day_of_week);
CREATE INDEX idx_price_analytics_chat ON price_analytics(chat_id);
```

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```sql
-- –ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
SELECT 
    price, 
    found_at, 
    airline
FROM price_analytics
WHERE route_id = ? AND chat_id = ?
ORDER BY found_at ASC;
```

***

### 7Ô∏è‚É£ **user_subscriptions** (–ü–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–ø–∏—Å–∫–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```sql
CREATE TABLE user_subscriptions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    chat_id INTEGER NOT NULL UNIQUE,       -- FK ‚Üí user_settings
    subscription_type TEXT NOT NULL DEFAULT 'free', -- FK ‚Üí subscription_types
    
    valid_from DATETIME DEFAULT CURRENT_TIMESTAMP,
    valid_to DATETIME,                     -- NULL –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
    is_active INTEGER DEFAULT 1,           -- 0 = –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞, 1 = –∞–∫—Ç–∏–≤–Ω–∞
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (chat_id) REFERENCES user_settings(chat_id)
);
```

**–°–≤—è–∑–∏:**
- `1:1` —Å `user_settings` (–æ–¥–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞ ‚Üí –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
- `N:1` —Å `subscription_types` (–º–Ω–æ–≥–æ –ø–æ–¥–ø–∏—Å–æ–∫ ‚Üí –æ–¥–∏–Ω —Ç–∏–ø)

**–ò–Ω–¥–µ–∫—Å—ã:**
```sql
CREATE INDEX idx_user_subscriptions_chat_id ON user_subscriptions(chat_id);
CREATE INDEX idx_user_subscriptions_valid_to ON user_subscriptions(valid_to);
CREATE INDEX idx_user_subscriptions_type ON user_subscriptions(subscription_type);
```

***

### 8Ô∏è‚É£ **subscription_types** (–¢–∏–ø—ã –ø–æ–¥–ø–∏—Å–æ–∫)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∏–ø—ã –ø–æ–¥–ø–∏—Å–æ–∫ –∏ –∏—Ö –ª–∏–º–∏—Ç—ã

```sql
CREATE TABLE subscription_types (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,             -- 'free', 'plus', 'admin'
    display_name TEXT NOT NULL,            -- –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
    
    max_fixed_routes INTEGER NOT NULL,     -- –ú–∞–∫—Å. —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
    max_flexible_routes INTEGER NOT NULL,  -- –ú–∞–∫—Å. –≥–∏–±–∫–∏—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
    max_combinations INTEGER NOT NULL,     -- –ú–∞–∫—Å. –∫–æ–º–±–∏–Ω–∞—Ü–∏–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    check_interval_hours INTEGER NOT NULL, -- –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–æ–∫ (—á–∞—Å—ã)
    
    price_per_month REAL DEFAULT 0,        -- –¶–µ–Ω–∞ –≤ –º–µ—Å—è—Ü
    is_active INTEGER DEFAULT 1,           -- –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- –ë–∞–∑–æ–≤—ã–µ —Ç–∏–ø—ã
INSERT INTO subscription_types VALUES
('free', '–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è', 3, 1, 20, 4, 0),
('plus', 'Plus', 5, 3, 50, 2, 199),
('admin', 'Admin', 999, 999, 999, 1, 0);
```

**–°–≤—è–∑–∏:**
- `1:N` —Å `user_subscriptions` (–æ–¥–∏–Ω —Ç–∏–ø ‚Üí –º–Ω–æ–≥–æ –ø–æ–¥–ø–∏—Å–æ–∫)

***

### 9Ô∏è‚É£ **user_stats** (–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

```sql
CREATE TABLE user_stats (
    chat_id INTEGER PRIMARY KEY,           -- FK ‚Üí user_settings
    total_routes INTEGER DEFAULT 0,        -- –í—Å–µ–≥–æ –º–∞—Ä—à—Ä—É—Ç–æ–≤
    total_alerts INTEGER DEFAULT 0,        -- –í—Å–µ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
    total_savings REAL DEFAULT 0,          -- –û–±—â–∞—è —ç–∫–æ–Ω–æ–º–∏—è
    total_checks INTEGER DEFAULT 0,        -- –í—Å–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
    last_check DATETIME,                   -- –ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

***

### üîü **notification_cooldown** (–¢–∞–π–º–∞—É—Ç—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∞–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

```sql
CREATE TABLE notification_cooldown (
    chat_id INTEGER PRIMARY KEY,
    last_notification INTEGER NOT NULL     -- Unix timestamp
);
```

***

## üîç –ü–†–ò–ú–ï–†–´ –ó–ê–ü–†–û–°–û–í

### üìå –ü–æ–ª—É—á–∏—Ç—å –ª—É—á—à–∏–µ —Ü–µ–Ω—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –º–∞—Ä—à—Ä—É—Ç—É

```sql
-- –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ route_results (–Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –±–∏–ª–µ—Ç—ã)
SELECT 
    rr.id,
    rr.departure_date,
    rr.return_date,
    rr.total_price,
    rr.airline,
    rr.search_link,
    rr.found_at,
    ur.origin,
    ur.destination,
    ur.threshold_price
FROM route_results rr
JOIN unified_routes ur ON rr.route_id = ur.id
WHERE ur.chat_id = ?           -- ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  AND ur.id = ?                -- ID –º–∞—Ä—à—Ä—É—Ç–∞
ORDER BY rr.total_price ASC
LIMIT 10;

-- –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ price_analytics (–≤—Å—è –∏—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω)
SELECT 
    pa.price,
    pa.airline,
    pa.found_at,
    ur.origin,
    ur.destination
FROM price_analytics pa
JOIN unified_routes ur ON pa.route_id = ur.id
WHERE ur.chat_id = ?
  AND ur.id = ?
ORDER BY pa.price ASC, pa.found_at DESC
LIMIT 10;
```

**–°–≤—è–∑—å —Ç–∞–±–ª–∏—Ü:**
```
user_settings (chat_id) 
    ‚Üì 1:N
unified_routes (id, chat_id)
    ‚Üì 1:N
route_results (route_id) ‚Üí –ª—É—á—à–∏–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –±–∏–ª–µ—Ç—ã
price_analytics (route_id, chat_id) ‚Üí –≤—Å—è –∏—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω
```

***

### üìå –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –º–∞—Ä—à—Ä—É—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤

```sql
SELECT 
    ur.*,
    COUNT(DISTINCT rr.id) as total_results,
    MIN(rr.total_price) as best_price,
    (SELECT COUNT(*) FROM route_check_stats WHERE route_id = ur.id) as check_count
FROM unified_routes ur
LEFT JOIN route_results rr ON ur.id = rr.route_id
WHERE ur.chat_id = ?
GROUP BY ur.id
ORDER BY ur.created_at DESC;
```

**–°–≤—è–∑—å —Ç–∞–±–ª–∏—Ü:**
```
user_settings (chat_id)
    ‚Üì
unified_routes (id, chat_id)
    ‚Üì LEFT JOIN
route_results (route_id) ‚Üí –ø–æ–¥—Å—á–µ—Ç –±–∏–ª–µ—Ç–æ–≤
route_check_stats (route_id) ‚Üí –ø–æ–¥—Å—á–µ—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫
```

***

### üìå –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤

```sql
SELECT 
    cs.id,
    cs.check_timestamp,
    cs.total_combinations,
    cs.successful_checks,
    cs.failed_checks,
    (ur.origin || ' ‚Üí ' || ur.destination) as route_name,
    ur.chat_id,
    us.timezone
FROM route_check_stats cs
JOIN unified_routes ur ON cs.route_id = ur.id
JOIN user_settings us ON ur.chat_id = us.chat_id
WHERE cs.check_timestamp >= datetime('now', '-7 days')
ORDER BY cs.check_timestamp DESC;
```

**–°–≤—è–∑—å —Ç–∞–±–ª–∏—Ü:**
```
route_check_stats (route_id)
    ‚Üì
unified_routes (id, chat_id) ‚Üí –ø–æ–ª—É—á–∏—Ç—å origin/destination
    ‚Üì
user_settings (chat_id) ‚Üí –ø–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

***

### üìå –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –º–∞—Ä—à—Ä—É—Ç–æ–≤

```sql
SELECT 
    us.chat_id,
    us.timezone,
    COUNT(ur.id) as total_routes,
    COUNT(CASE WHEN ur.is_paused = 0 THEN 1 END) as active_routes,
    usub.subscription_type
FROM user_settings us
LEFT JOIN unified_routes ur ON us.chat_id = ur.chat_id
LEFT JOIN user_subscriptions usub ON us.chat_id = usub.chat_id
GROUP BY us.chat_id
ORDER BY total_routes DESC
LIMIT 10;
```

**–°–≤—è–∑—å —Ç–∞–±–ª–∏—Ü:**
```
user_settings (chat_id)
    ‚Üì LEFT JOIN
unified_routes (chat_id) ‚Üí –ø–æ–¥—Å—á–µ—Ç –º–∞—Ä—à—Ä—É—Ç–æ–≤
    ‚Üì LEFT JOIN
user_subscriptions (chat_id) ‚Üí —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏
```

***

## üéØ –ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ò–ú–ï–†–´

### –ü—Ä–∏–º–µ—Ä 1: –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ –º–∞—Ä—à—Ä—É—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```sql
-- –ú–∞—Ä—à—Ä—É—Ç + –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è + –ø–æ–¥–ø–∏—Å–∫–∞ + —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
SELECT 
    ur.*,
    us.timezone,
    us.quiet_hours_start,
    us.quiet_hours_end,
    usub.subscription_type,
    (SELECT COUNT(*) FROM route_results WHERE route_id = ur.id) as total_results,
    (SELECT MIN(total_price) FROM route_results WHERE route_id = ur.id) as best_price,
    (SELECT COUNT(*) FROM route_check_stats WHERE route_id = ur.id) as total_checks
FROM unified_routes ur
JOIN user_settings us ON ur.chat_id = us.chat_id
LEFT JOIN user_subscriptions usub ON ur.chat_id = usub.chat_id
WHERE ur.id = ?;
```

### –ü—Ä–∏–º–µ—Ä 2: –ù–µ—É–¥–∞—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

```sql
SELECT 
    ccr.id,
    ccr.departure_date,
    ccr.return_date,
    ccr.status,
    ccr.error_reason,
    ccr.check_timestamp,
    (ur.origin || ' ‚Üí ' || ur.destination) as route,
    ur.chat_id,
    ur.threshold_price,
    us.timezone
FROM combination_check_results ccr
JOIN unified_routes ur ON ccr.route_id = ur.id
JOIN user_settings us ON ur.chat_id = us.chat_id
WHERE ccr.status = 'error'
  AND ccr.check_timestamp >= datetime('now', '-1 day')
ORDER BY ccr.check_timestamp DESC;
```

***

## üìñ –í–´–í–û–î–´

### –û—Å–Ω–æ–≤–Ω—ã–µ —Å–≤—è–∑–∏:

1. **user_settings** ‚Äî –∫–æ—Ä–Ω–µ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. **unified_routes** ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞, —Å–≤—è–∑—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
3. **route_results** ‚Äî –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –±–∏–ª–µ—Ç—ã (—Ü–µ–Ω–∞ ‚â§ –ø–æ—Ä–æ–≥–∞)
4. **price_analytics** ‚Äî –≤—Å—è –∏—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
5. **route_check_stats** ‚Äî –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫
6. **combination_check_results** ‚Äî –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

### –ö–ª—é—á–µ–≤—ã–µ Foreign Keys:

- `unified_routes.chat_id` ‚Üí `user_settings.chat_id`
- `route_results.route_id` ‚Üí `unified_routes.id`
- `route_check_stats.route_id` ‚Üí `unified_routes.id`
- `combination_check_results.route_id` ‚Üí `unified_routes.id`
- `price_analytics.route_id` ‚Üí `unified_routes.id`
- `price_analytics.chat_id` ‚Üí `user_settings.chat_id`
- `user_subscriptions.chat_id` ‚Üí `user_settings.chat_id`

–¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å –ø–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö! üéâ