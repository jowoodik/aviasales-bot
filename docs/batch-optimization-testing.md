# Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ Ð¿Ð¾ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÑŽ batch-Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸

## ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ðº Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÑŽ

### 1. Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð°Ñ ÐºÐ¾Ð¿Ð¸Ñ Ð‘Ð”
```bash
cp data/bot.db data/bot.db.backup-$(date +%Y%m%d)
```

### 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ
```bash
# Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð° Ð² Ñ€ÐµÐ¶Ð¸Ð¼Ðµ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
npm run dev

# Ð˜Ð»Ð¸ Ð·Ð°Ð¿ÑƒÑÐº Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ñ‰Ð¸ÐºÐ°
node scheduler.js
```

## Unit-Ñ‚ÐµÑÑ‚Ñ‹

### Ð¢ÐµÑÑ‚ 1: prepareBatchItem() Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ

**Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»:** `tests/batch-optimization.test.js`

```javascript
const UnifiedMonitor = require('../services/UnifiedMonitor');
const bot = { /* mock */ };

const monitor = new UnifiedMonitor(process.env.TRAVELPAYOUTS_TOKEN, bot);

// Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚
const testRoute = {
  id: 1,
  chat_id: 123,
  origin: 'MOW',
  destination: 'DXB',
  departure_date_start: '2026-03-01',
  departure_date_end: '2026-03-05',
  return_date_start: '2026-03-10',
  return_date_end: '2026-03-15',
  days_in_country: 7,
  is_flexible: 1,
  airline: 'EK',
  baggage: 1,
  max_stops: 1,
  max_layover_hours: 6,
  adults: 2,
  children: 0
};

// Ð¢ÐµÑÑ‚
const items = monitor.prepareBatchItem(testRoute);

console.log('ðŸ“‹ Ð¢ÐµÑÑ‚ prepareBatchItem():');
console.log(`  âœ“ ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ items: ${items.length}`);
console.log(`  âœ“ ÐŸÐµÑ€Ð²Ñ‹Ð¹ item:`, items[0]);

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ¸
if (items.length === 0) {
  console.error('  âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: items Ð¿ÑƒÑÑ‚Ð¾Ð¹!');
}

if (!items[0].url) {
  console.error('  âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: url Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚!');
}

if (!items[0].combination) {
  console.error('  âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: combination Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚!');
}

if (items[0].airline !== 'EK') {
  console.error('  âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: airline Ð½Ðµ ÑÐ¾Ð²Ð¿Ð°Ð´Ð°ÐµÑ‚!');
}

if (items[0].baggage !== true) {
  console.error('  âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: baggage Ð½Ðµ ÑÐ¾Ð²Ð¿Ð°Ð´Ð°ÐµÑ‚!');
}

if (items[0].max_stops !== 1) {
  console.error('  âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: max_stops Ð½Ðµ ÑÐ¾Ð²Ð¿Ð°Ð´Ð°ÐµÑ‚!');
}

console.log('  âœ… Ð’ÑÐµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹!');
```

**Ð—Ð°Ð¿ÑƒÑÐº:**
```bash
node tests/batch-optimization.test.js
```

### Ð¢ÐµÑÑ‚ 2: processBatchResults() ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² Ð‘Ð”

**Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð² Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»:**

```javascript
// ÐœÐ¾Ðº Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²
const mockResults = [
  {
    combination: { departure_date: '2026-03-01', return_date: '2026-03-10', days_in_country: 7 },
    priceResult: { price: 50000, currency: 'RUB', enhancedSearchLink: 'https://...' },
    url: 'https://...'
  },
  {
    combination: { departure_date: '2026-03-02', return_date: '2026-03-11', days_in_country: 7 },
    priceResult: { price: 52000, currency: 'RUB', enhancedSearchLink: 'https://...' },
    url: 'https://...'
  }
];

// Ð¢ÐµÑÑ‚
await monitor.processBatchResults(testRoute.id, testRoute, mockResults);

console.log('ðŸ“‹ Ð¢ÐµÑÑ‚ processBatchResults():');
console.log('  âœ“ Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ñ‹ Ð² Ð‘Ð”');

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð‘Ð”
const RouteResult = require('../models/RouteResult');
const results = await RouteResult.getTopResults(testRoute.id, 10);

console.log(`  âœ“ ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð² Ð‘Ð”: ${results.length}`);

if (results.length !== 2) {
  console.error('  âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: Ð½ÐµÐ²ÐµÑ€Ð½Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²!');
} else {
  console.log('  âœ… Ð’ÑÐµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹!');
}
```

## Integration-Ñ‚ÐµÑÑ‚Ñ‹

### Ð¢ÐµÑÑ‚ 3: Batch Ð¸Ð· 30 Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð²

**Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚:** `tests/batch-30-routes.test.js`

```javascript
// 1. Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ 3 Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
// 2. Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¿Ð¾ 10 Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð² Ð½Ð° ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾
// 3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ checkRoutesBySubscriptionBatch('admin')
// 4. ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ:
//    - Ð’ÑÐµ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½Ñ‹
//    - Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ñ‹ Ð² Ð‘Ð”
//    - Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾
//    - Ð’Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¸ÐµÐ¼Ð»ÐµÐ¼Ð¾Ðµ
```

**ÐŸÑ€Ð¸Ð¼ÐµÑ€:**
```javascript
const { checkRoutesBySubscription } = require('../scheduler');

console.log('ðŸ“‹ Ð¢ÐµÑÑ‚ batch Ð¸Ð· 30 Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð²');
const startTime = Date.now();

await checkRoutesBySubscription('admin');

const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
console.log(`âœ“ Ð’Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ: ${elapsed}s`);

// ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚: ~30-40 ÑÐµÐºÑƒÐ½Ð´ (Ð²Ð¼ÐµÑÑ‚Ð¾ 300+ ÑÐµÐºÑƒÐ½Ð´)
if (elapsed > 60) {
  console.warn('  âš ï¸ Ð’Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð±Ð¾Ð»ÑŒÑˆÐ¾Ðµ!');
}
```

### Ð¢ÐµÑÑ‚ 4: Ð¡Ð¼ÐµÑˆÐ°Ð½Ð½Ñ‹Ðµ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ (Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ðµ + Ð³Ð¸Ð±ÐºÐ¸Ðµ)

```javascript
// 1. Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ 10 Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ñ… Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð² (is_flexible=0)
// 2. Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ 2 Ð³Ð¸Ð±ÐºÐ¸Ñ… Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð° (is_flexible=1, 20 ÐºÐ¾Ð¼Ð±Ð¸Ð½Ð°Ñ†Ð¸Ð¹ ÐºÐ°Ð¶Ð´Ñ‹Ð¹)
// 3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ batch-Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ
// 4. ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ:
//    - Ð’ÑÐµ ÐºÐ¾Ð¼Ð±Ð¸Ð½Ð°Ñ†Ð¸Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ñ‹
//    - Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾
//    - Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Ð¾Ð¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ð¼
```

### Ð¢ÐµÑÑ‚ 5: Ð Ð°Ð·Ð½Ñ‹Ðµ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ Ñƒ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð²

```javascript
// Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ Ñ Ñ€Ð°Ð·Ð½Ñ‹Ð¼Ð¸ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ð¼Ð¸:
const routes = [
  { airline: 'EK', baggage: 1, max_stops: 0 },  // ÐŸÑ€ÑÐ¼Ð¾Ð¹ Emirates Ñ Ð±Ð°Ð³Ð°Ð¶Ð¾Ð¼
  { airline: null, baggage: 0, max_stops: 1 },   // Ð›ÑŽÐ±Ð°Ñ Ð°/Ðº Ð±ÐµÐ· Ð±Ð°Ð³Ð°Ð¶Ð°, 1 Ð¿ÐµÑ€ÐµÑÐ°Ð´ÐºÐ°
  { airline: 'SU', baggage: 1, max_stops: 2 },   // ÐÑÑ€Ð¾Ñ„Ð»Ð¾Ñ‚ Ñ Ð±Ð°Ð³Ð°Ð¶Ð¾Ð¼, 2 Ð¿ÐµÑ€ÐµÑÐ°Ð´ÐºÐ¸
];

// Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ batch-Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ Ð¸ ÑƒÐ±ÐµÐ´Ð¸Ñ‚ÑŒÑÑ Ñ‡Ñ‚Ð¾:
// - ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½ ÑÐ¾ ÑÐ²Ð¾Ð¸Ð¼Ð¸ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ð¼Ð¸
// - Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð°ÑŽÑ‚ÑÑ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, EK Ð´Ð¾Ñ€Ð¾Ð¶Ðµ SU)
```

### Ð¢ÐµÑÑ‚ 6: NO_RESULTS ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¹

```javascript
// 1. Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚ Ñ Ð½ÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ð¼Ð¸ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ð¼Ð¸ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð½Ð° Ð·Ð°Ð²Ñ‚Ñ€Ð° Ð² ÐÐ½Ñ‚Ð°Ñ€ÐºÑ‚Ð¸Ð´Ñƒ)
// 2. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ batch-Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ
// 3. ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ:
//    - ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾ ÐºÐ°Ðº NO_RESULTS
//    - ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ NO_RESULTS ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ (ÐµÑÐ»Ð¸ Ð¿Ñ€Ð¾ÑˆÐ»Ð¾ 48Ñ‡)
//    - Ð”Ñ€ÑƒÐ³Ð¸Ðµ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ Ð½Ðµ Ð¿Ð¾ÑÑ‚Ñ€Ð°Ð´Ð°Ð»Ð¸
```

## Staging Ñ‚ÐµÑÑ‚Ñ‹

### Ð¢ÐµÑÑ‚ 7: Ð ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ

**ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ°:**
```bash
# ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ production Ð‘Ð” Ð½Ð° staging
scp production:/path/to/bot.db ./data/bot.db.staging

# Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð½Ð° staging
NODE_ENV=staging node scheduler.js
```

**ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ¸:**
1. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ñ‰Ð¸Ðº Ð½Ð° 1 Ñ‡Ð°Ñ
2. Ð¡Ñ€Ð°Ð²Ð½Ð¸Ñ‚ÑŒ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ñ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¼ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼:
   - ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½Ð½Ñ‹Ñ… Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð²
   - ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ… ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹
   - Ð¢Ð¸Ð¿Ñ‹ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ (CRITICAL/HIGH/LOW)
3. ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸ Ð½Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ¸
4. Ð˜Ð·Ð¼ÐµÑ€Ð¸Ñ‚ÑŒ Ð²Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ

**ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹:**
- Ð’Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ: ÑÐ¾ÐºÑ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ Ð² 2-10x
- ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹: Ñ‚Ð°ÐºÐ¾Ðµ Ð¶Ðµ
- ÐžÑˆÐ¸Ð±ÐºÐ¸: Ð½Ðµ Ð´Ð¾Ð»Ð¶Ð½Ð¾ ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ñ‚ÑŒÑÑ

### Ð¢ÐµÑÑ‚ 8: Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ Ñ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð»Ð¾Ð³Ð¸ÐºÐ¾Ð¹

**Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾:**
1. Ð¡Ñ‚Ð°Ñ€Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ (Ð½Ð° Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ð‘Ð”-ÐºÐ¾Ð¿Ð¸Ð¸)
2. ÐÐ¾Ð²Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ (Ð½Ð° staging)

**Ð¡Ñ€Ð°Ð²Ð½Ð¸Ñ‚ÑŒ:**
```sql
-- ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²
SELECT COUNT(*) FROM route_results WHERE found_at >= datetime('now', '-1 hour');

-- ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹
SELECT priority, COUNT(*) FROM notification_log WHERE sent_at >= datetime('now', '-1 hour') GROUP BY priority;

-- Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº
SELECT
  AVG(successful_checks) as avg_success,
  AVG(failed_checks) as avg_failed
FROM route_check_stats
WHERE check_timestamp >= datetime('now', '-1 hour');
```

## Production rollout

### Ð­Ñ‚Ð°Ð¿ 1: Admin Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ° (Ð´ÐµÐ½ÑŒ 1)

```bash
# Ð’ scheduler.js Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð²ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ batch Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ admin
async function checkAllSubscriptionsSequentially() {
  const priorityOrder = ['admin', 'plus', 'free'];

  for (const type of priorityOrder) {
    if (type === 'admin') {
      // BATCH Ð´Ð»Ñ admin
      await checkRoutesBySubscription('admin');
    } else {
      // Ð¡Ñ‚Ð°Ñ€Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð´Ð»Ñ plus/free
      const users = await getUsersBySubscription(type);
      for (const user of users) {
        await checkUserRoutes(user.chat_id, monitor, notificationService, type);
      }
    }
  }
}
```

**ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³:**
- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑ‚ÑŒ Ð»Ð¾Ð³Ð¸ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ‡Ð°Ñ
- Ð¡Ð»ÐµÐ´Ð¸Ñ‚ÑŒ Ð·Ð° Ð²Ñ€ÐµÐ¼ÐµÐ½ÐµÐ¼ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ
- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑ‚ÑŒ Ð¶Ð°Ð»Ð¾Ð±Ñ‹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)

### Ð­Ñ‚Ð°Ð¿ 2: Plus Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ° (Ð´ÐµÐ½ÑŒ 2-3)

ÐŸÐ¾ÑÐ»Ðµ 24-48 Ñ‡Ð°ÑÐ¾Ð² ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ admin:
- Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ batch Ð´Ð»Ñ plus
- ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³

### Ð­Ñ‚Ð°Ð¿ 3: Free Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ° (Ð´ÐµÐ½ÑŒ 4-5)

ÐŸÐ¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ admin + plus:
- Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ batch Ð´Ð»Ñ Ð²ÑÐµÑ…
- Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ ÐºÐ¾Ð´
- ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ rollout

## Rollback Ð¿Ð»Ð°Ð½

Ð•ÑÐ»Ð¸ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ð¿Ð¾ÑˆÐ»Ð¾ Ð½Ðµ Ñ‚Ð°Ðº:

### Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ rollback
```bash
git revert HEAD
git push
pm2 restart aviasales-bot
pm2 restart scheduler
```

### Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð‘Ð”
```bash
# Ð•ÑÐ»Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð²Ñ€ÐµÐ¶Ð´ÐµÐ½Ñ‹
cp data/bot.db.backup-20260209 data/bot.db
```

### Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð¸ÐºÑ (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð½Ð° Ð´ÐµÐ±Ð°Ð³)
```javascript
// Ð’ scheduler.js Ð·Ð°ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ batch-Ð²ÐµÑ€ÑÐ¸ÑŽ:
async function checkRoutesBySubscription(subscriptionType) {
  // await checkRoutesBySubscriptionBatch(...); // Ð’Ð Ð•ÐœÐ•ÐÐÐž ÐžÐ¢ÐšÐ›Ð®Ð§Ð•ÐÐž

  // Ð’ÐµÑ€Ð½ÑƒÑ‚ÑŒ ÑÑ‚Ð°Ñ€ÑƒÑŽ Ð»Ð¾Ð³Ð¸ÐºÑƒ:
  for (const user of users) {
    await checkUserRoutes(user.chat_id, monitor, notificationService, subscriptionType);
  }
}
```

## ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ÑÑ‚Ð¸

### Ð”Ð¾ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ (baseline):
```
ÐŸÐ¾Ð´Ð¿Ð¸ÑÐºÐ° admin (10 Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ã— 3 Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð°):
- Ð’Ñ€ÐµÐ¼Ñ: ~300 ÑÐµÐºÑƒÐ½Ð´
- Ð£ÑÐ¿ÐµÑˆÐ½Ñ‹Ñ… Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº: 28/30
- Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾: 5

ÐŸÐ¾Ð´Ð¿Ð¸ÑÐºÐ° plus (50 Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ã— 2 Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð°):
- Ð’Ñ€ÐµÐ¼Ñ: ~1000 ÑÐµÐºÑƒÐ½Ð´
- Ð£ÑÐ¿ÐµÑˆÐ½Ñ‹Ñ… Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº: 95/100
- Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾: 15
```

### ÐŸÐ¾ÑÐ»Ðµ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ (Ð¾Ð¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹):
```
ÐŸÐ¾Ð´Ð¿Ð¸ÑÐºÐ° admin:
- Ð’Ñ€ÐµÐ¼Ñ: ~30 ÑÐµÐºÑƒÐ½Ð´ (Ð¿Ñ€Ð¸Ñ€Ð¾ÑÑ‚ 10x)
- Ð£ÑÐ¿ÐµÑˆÐ½Ñ‹Ñ… Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº: 28/30 (Ð±ÐµÐ· Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹)
- Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾: 5 (Ð±ÐµÐ· Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹)

ÐŸÐ¾Ð´Ð¿Ð¸ÑÐºÐ° plus:
- Ð’Ñ€ÐµÐ¼Ñ: ~100 ÑÐµÐºÑƒÐ½Ð´ (Ð¿Ñ€Ð¸Ñ€Ð¾ÑÑ‚ 10x)
- Ð£ÑÐ¿ÐµÑˆÐ½Ñ‹Ñ… Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº: 95/100 (Ð±ÐµÐ· Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹)
- Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾: 15 (Ð±ÐµÐ· Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹)
```

### ÐšÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¸ ÑƒÑÐ¿ÐµÑ…Ð°:
- âœ… Ð’Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ ÑÐ¾ÐºÑ€Ð°Ñ‚Ð¸Ð»Ð¾ÑÑŒ Ð² 2-10x
- âœ… ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ñ… Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº Ð½Ðµ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¾ÑÑŒ (Â±5%)
- âœ… ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ Ð½Ðµ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¾ÑÑŒ (Â±10%)
- âœ… ÐÐµÑ‚ Ð½Ð¾Ð²Ñ‹Ñ… Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð² Ð»Ð¾Ð³Ð°Ñ…
- âœ… ÐÐµÑ‚ Ð¶Ð°Ð»Ð¾Ð± Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹

## Ð§ÐµÐºÐ»Ð¸ÑÑ‚ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ

- [ ] Unit-Ñ‚ÐµÑÑ‚: `prepareBatchItem()` Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾
- [ ] Unit-Ñ‚ÐµÑÑ‚: `processBatchResults()` ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² Ð‘Ð”
- [ ] Integration-Ñ‚ÐµÑÑ‚: batch Ð¸Ð· 30 Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð²
- [ ] Integration-Ñ‚ÐµÑÑ‚: ÑÐ¼ÐµÑˆÐ°Ð½Ð½Ñ‹Ðµ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ (Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ðµ + Ð³Ð¸Ð±ÐºÐ¸Ðµ)
- [ ] Integration-Ñ‚ÐµÑÑ‚: Ñ€Ð°Ð·Ð½Ñ‹Ðµ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ Ñƒ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð²
- [ ] Integration-Ñ‚ÐµÑÑ‚: NO_RESULTS ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¹
- [ ] Staging: Ð·Ð°Ð¿ÑƒÑÐº Ð½Ð° Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
- [ ] Staging: ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ Ñ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð»Ð¾Ð³Ð¸ÐºÐ¾Ð¹
- [ ] Staging: Ð¸Ð·Ð¼ÐµÑ€ÐµÐ½Ð¸Ðµ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ
- [ ] Production: rollout Ð´Ð»Ñ admin (Ð´ÐµÐ½ÑŒ 1)
- [ ] Production: rollout Ð´Ð»Ñ plus (Ð´ÐµÐ½ÑŒ 2-3)
- [ ] Production: rollout Ð´Ð»Ñ free (Ð´ÐµÐ½ÑŒ 4-5)
- [ ] Production: Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¼ÐµÑ‚Ñ€Ð¸Ðº 7 Ð´Ð½ÐµÐ¹

## ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹

```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð‘Ð”
sqlite3 data/bot.db "SELECT COUNT(*) FROM route_results"

# Ð›Ð¾Ð³Ð¸ Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ñ‰Ð¸ÐºÐ°
pm2 logs scheduler --lines 100

# Ð’Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº
sqlite3 data/bot.db "
SELECT
  check_timestamp,
  total_combinations,
  successful_checks,
  failed_checks
FROM route_check_stats
ORDER BY check_timestamp DESC
LIMIT 10
"

# Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ñ‡Ð°Ñ
sqlite3 data/bot.db "
SELECT
  priority,
  COUNT(*) as count,
  SUM(CASE WHEN disable_notification = 1 THEN 1 ELSE 0 END) as silent
FROM notification_log
WHERE sent_at >= datetime('now', '-1 hour')
GROUP BY priority
"
```
