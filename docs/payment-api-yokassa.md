# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: –ü—Ä—è–º–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Æ–ö–∞—Å—Å–∞ API

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
- [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
- [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
- [–§–ª–æ—É –æ–ø–ª–∞—Ç—ã](#—Ñ–ª–æ—É-–æ–ø–ª–∞—Ç—ã)
- [API –∏ –º–µ—Ç–æ–¥—ã](#api-–∏-–º–µ—Ç–æ–¥—ã)
- [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
- [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
- [Troubleshooting](#troubleshooting)
- [–ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã](#–º–∏–≥—Ä–∞—Ü–∏—è-—Å–æ-—Å—Ç–∞—Ä–æ–π-—Å–∏—Å—Ç–µ–º—ã)

---

## –û–±–∑–æ—Ä

### –ó–∞—á–µ–º –ø—Ä—è–º–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è?

**–ü—Ä–æ–±–ª–µ–º–∞ Telegram Payments API:**
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –Ω–∞–±–æ—Ä —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã
- –ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –°–ë–ü (–°–∏—Å—Ç–µ–º—ã –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π)
- –ñ—ë—Å—Ç–∫–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—É —á–µ—Ä–µ–∑ —Ç–æ–∫–µ–Ω
- –°–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏–µ–π –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–ø–ª–∞—Ç—ã

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø—Ä—è–º–æ–≥–æ API –Æ–ö–∞—Å—Å—ã:**
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –°–ë–ü
- ‚úÖ –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã, –ÆMoney, Qiwi –∏ –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã
- ‚úÖ –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ø—Ä–æ—Ü–µ—Å—Å–æ–º –æ–ø–ª–∞—Ç—ã
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
- ‚úÖ Webhook –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ –∏ –æ—Ç–º–µ–Ω

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ 1. –ù–∞–∂–∏–º–∞–µ—Ç "–û–ø–ª–∞—Ç–∏—Ç—å 199‚ÇΩ"
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  handlers/subscriptionHandlers.js   ‚îÇ
‚îÇ  - handlePaymentCallback()          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ
         ‚îÇ 2. –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂     ‚îÇ 6. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
         ‚ñº                       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ services/YooKassaService ‚îÇ     ‚îÇ
‚îÇ - createPayment()        ‚îÇ     ‚îÇ
‚îÇ - getPayment()           ‚îÇ     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
         ‚îÇ                       ‚îÇ
         ‚îÇ 3. POST /v3/payments  ‚îÇ
         ‚ñº                       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ    –Æ–ö–∞—Å—Å–∞ API           ‚îÇ     ‚îÇ
‚îÇ  api.yookassa.ru/v3     ‚îÇ     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
         ‚îÇ                       ‚îÇ
         ‚îÇ 4. Confirmation URL   ‚îÇ
         ‚ñº                       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
‚îÇ   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å  ‚îÇ              ‚îÇ
‚îÇ  –û–ø–ª–∞—á–∏–≤–∞–µ—Ç     ‚îÇ              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
         ‚îÇ                       ‚îÇ
         ‚îÇ 5. Webhook            ‚îÇ
         ‚ñº                       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ   web/server.js          ‚îÇ    ‚îÇ
‚îÇ   POST /webhook/yookassa ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ   - –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è          ‚îÇ
‚îÇ   - –û–±—Ä–∞–±–æ—Ç–∫–∞            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-----------|
| `services/YooKassaService.js` | –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å API –Æ–ö–∞—Å—Å—ã |
| `handlers/subscriptionHandlers.js` | –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ |
| `web/server.js` | Webhook endpoint |
| `config/database.js` | –°—Ö–µ–º–∞ –ë–î –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π |

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ `.env`:

```bash
# –Æ–ö–∞—Å—Å–∞ (–ø—Ä—è–º–æ–µ API)
YOOKASSA_SHOP_ID=123456
YOOKASSA_API_KEY=test_secretkey
BOT_USERNAME=YourBotName

# –í–µ–±-—Å–µ—Ä–≤–µ—Ä (–Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è webhook)
ENABLE_WEB=true
WEB_PORT=3000
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ credentials

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –≤ [–Æ–ö–∞—Å—Å–∞](https://yookassa.ru/)
2. –°–æ–∑–¥–∞–π—Ç–µ –º–∞–≥–∞–∑–∏–Ω
3. –í —Ä–∞–∑–¥–µ–ª–µ "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è" ‚Üí "API":
   - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ `shopId` ‚Üí `YOOKASSA_SHOP_ID`
   - –°–æ–∑–¥–∞–π—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á ‚Üí `YOOKASSA_API_KEY`
4. –í Telegram –ø–æ–ª—É—á–∏—Ç–µ `@username` –±–æ—Ç–∞ ‚Üí `BOT_USERNAME`

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook –≤ –Æ–ö–∞—Å—Å–µ

1. –õ–ö –Æ–ö–∞—Å—Å—ã ‚Üí "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è" ‚Üí "HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
2. URL: `https://your-domain.com/webhook/yookassa`
3. –°–æ–±—ã—Ç–∏—è:
   - ‚úÖ `payment.succeeded` ‚Äî —É—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞
   - ‚úÖ `payment.canceled` ‚Äî –æ—Ç–º–µ–Ω–∞ –ø–ª–∞—Ç–µ–∂–∞

---

## –§–ª–æ—É –æ–ø–ª–∞—Ç—ã

### 1. –ò–Ω–∏—Ü–∏–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞

**–¢—Ä–∏–≥–≥–µ—Ä:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–û–ø–ª–∞—Ç–∏—Ç—å 199 ‚ÇΩ"

```javascript
// handlers/subscriptionHandlers.js
async handlePaymentCallback(chatId, callbackQueryId) {
    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    if (!YooKassaService.isConfigured()) {
        return error("–ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞");
    }

    // 2. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –≤ –Æ–ö–∞—Å—Å–µ
    const payment = await YooKassaService.createPayment({
        amount: 199,
        chatId: chatId,
        subscriptionType: 'plus',
        returnUrl: 'https://t.me/YourBotName'
    });

    // 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
    await _createPaymentRecord(
        chatId,
        payload,
        'plus',
        19900,  // –∫–æ–ø–µ–π–∫–∏
        payment.id,  // yookassa_payment_id
        payment.confirmationUrl
    );

    // 4. –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    bot.sendMessage(chatId, "...", {
        inline_keyboard: [[
            { text: 'üí≥ –û–ø–ª–∞—Ç–∏—Ç—å 199 ‚ÇΩ', url: payment.confirmationUrl }
        ]]
    });
}
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –≤ –Æ–ö–∞—Å—Å–µ

```javascript
// services/YooKassaService.js
async createPayment({ amount, chatId, subscriptionType, returnUrl }) {
    const response = await axios.post('https://api.yookassa.ru/v3/payments', {
        amount: {
            value: amount.toFixed(2),
            currency: 'RUB'
        },
        confirmation: {
            type: 'redirect',
            return_url: returnUrl
        },
        capture: true,  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ
        description: `Plus –ø–æ–¥–ø–∏—Å–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${chatId}`,
        metadata: {
            chat_id: chatId.toString(),
            subscription_type: subscriptionType
        }
    }, {
        auth: {
            username: SHOP_ID,
            password: API_KEY
        },
        headers: {
            'Idempotence-Key': `${chatId}_${Date.now()}_${randomId}`
        }
    });

    return {
        id: response.data.id,
        confirmationUrl: response.data.confirmation.confirmation_url,
        status: response.data.status
    };
}
```

### 3. –û–ø–ª–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
1. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ `confirmationUrl`
2. –í—ã–±–∏—Ä–∞–µ—Ç —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (–∫–∞—Ä—Ç–∞, –°–ë–ü, –ÆMoney)
3. –í–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç
4. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –±–æ—Ç (`returnUrl`)

### 4. Webhook –æ—Ç –Æ–ö–∞—Å—Å—ã

```javascript
// web/server.js
app.post('/webhook/yookassa', async (req, res) => {
    const notification = req.body;

    if (notification.event === 'payment.succeeded') {
        // 1. –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ API
        const verifiedPayment = await YooKassaService.getPayment(notification.object.id);

        if (verifiedPayment.status !== 'succeeded') {
            return res.status(200).json({ status: 'ignored' });
        }

        // 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞
        const subscriptionHandlers = new SubscriptionHandlers(botInstance, {});
        await subscriptionHandlers.handleYooKassaPaymentSuccess(verifiedPayment);

        res.status(200).json({ status: 'ok' });
    }
});
```

### 5. –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏

```javascript
// handlers/subscriptionHandlers.js
async handleYooKassaPaymentSuccess(paymentData) {
    const yookassaPaymentId = paymentData.id;
    const chatId = parseInt(paymentData.metadata.chat_id);

    // 1. –ü–æ–ª—É—á–∏—Ç—å –∑–∞–ø–∏—Å—å –∏–∑ –ë–î
    const paymentRecord = await _getPaymentByYookassaId(yookassaPaymentId);

    // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
    if (paymentRecord.status === 'completed') {
        return true;  // –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω
    }

    // 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
    await _updatePaymentStatusByYookassaId(yookassaPaymentId, 'completed');

    // 4. –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
    await SubscriptionService.updateSubscription(chatId, 'plus');

    // 5. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await bot.sendMessage(chatId, "üéâ –ü–æ–¥–ø–∏—Å–∫–∞ Plus –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!");

    return true;
}
```

---

## API –∏ –º–µ—Ç–æ–¥—ã

### YooKassaService

#### `createPayment(params)`

–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –≤ –Æ–ö–∞—Å—Å–µ.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```javascript
{
    amount: 199,              // –°—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö
    chatId: 123456789,        // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    subscriptionType: 'plus', // –¢–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏
    returnUrl: 'https://...'  // URL –≤–æ–∑–≤—Ä–∞—Ç–∞
}
```

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```javascript
{
    id: '2d97f526-000f-5000-8000-1516e5b4dc95',
    confirmationUrl: 'https://yoomoney.ru/payments/...',
    status: 'pending'
}
```

#### `getPayment(paymentId)`

–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–ª–∞—Ç–µ–∂–µ (–¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ webhook).

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```javascript
paymentId: '2d97f526-000f-5000-8000-1516e5b4dc95'
```

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
–ü–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç –ø–ª–∞—Ç–µ–∂–∞ –∏–∑ API –Æ–ö–∞—Å—Å—ã.

#### `isConfigured()`

–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è credentials.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `true` / `false`

---

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

#### –¢–∞–±–ª–∏—Ü–∞ `payments`

–ù–æ–≤—ã–µ –ø–æ–ª—è:

```sql
yookassa_payment_id TEXT       -- ID –ø–ª–∞—Ç–µ–∂–∞ –Æ–ö–∞—Å—Å—ã
confirmation_url TEXT          -- URL –¥–ª—è –æ–ø–ª–∞—Ç—ã
webhook_received_at DATETIME   -- –í—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è webhook

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
INDEX idx_payments_yookassa_id ON payments(yookassa_payment_id)
```

#### –ú–µ—Ç–æ–¥—ã –ë–î

**`_createPaymentRecord()`**
```javascript
_createPaymentRecord(
    chatId,
    payload,
    subscriptionType,
    amount,
    yookassaPaymentId,
    confirmationUrl
)
```

**`_getPaymentByYookassaId()`**
```javascript
const payment = await _getPaymentByYookassaId('2d97f526-...');
```

**`_updatePaymentStatusByYookassaId()`**
```javascript
await _updatePaymentStatusByYookassaId('2d97f526-...', 'completed');
```

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 1. –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è webhook

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–µ–π–∫–æ–≤—ã–π webhook.

**–†–µ—à–µ–Ω–∏–µ:** –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ GET –∑–∞–ø—Ä–æ—Å –∫ API –Æ–ö–∞—Å—Å—ã:

```javascript
// –ù–ò–ö–û–ì–î–ê –Ω–µ –¥–æ–≤–µ—Ä—è–π—Ç–µ webhook –Ω–∞–ø—Ä—è–º—É—é!
const paymentData = req.body.object;

// –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ API
const verifiedPayment = await YooKassaService.getPayment(paymentData.id);

if (verifiedPayment.status !== 'succeeded') {
    return res.status(200).json({ status: 'ignored' });
}

// –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ IP (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–Æ–ö–∞—Å—Å–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook —Å IP:
- `185.71.76.0/27`
- `185.71.77.0/27`
- `77.75.153.0/24`

```javascript
app.post('/webhook/yookassa', (req, res, next) => {
    const ip = req.ip;
    const allowedRanges = ['185.71.76.', '185.71.77.', '77.75.153.'];

    const isAllowed = allowedRanges.some(range => ip.startsWith(range));

    if (!isAllowed) {
        return res.status(403).json({ error: 'Forbidden' });
    }

    next();
});
```

### 3. –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

```javascript
// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ –ø–ª–∞—Ç–µ–∂ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω
if (paymentRecord.status === 'completed') {
    console.log(`‚ö†Ô∏è –ü–ª–∞—Ç–µ–∂ ${yookassaPaymentId} —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω`);
    return true;  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º success
}
```

### 4. Idempotence Key

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º idempotence key –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:

```javascript
headers: {
    'Idempotence-Key': `${chatId}_${Date.now()}_${randomId}`
}
```

### 5. –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 200 OK

**–í–∞–∂–Ω–æ:** –Æ–ö–∞—Å—Å–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç webhook –ø—Ä–∏ –æ—à–∏–±–∫–µ (–Ω–µ 200). –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ 200:

```javascript
app.post('/webhook/yookassa', async (req, res) => {
    try {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞...
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        // –í—Å—ë —Ä–∞–≤–Ω–æ 200!
        res.status(200).json({ status: 'error', message: error.message });
    }
});
```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã –Æ–ö–∞—Å—Å—ã

| –ö–∞—Ä—Ç–∞ | CVV | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|-------|-----|-----------|
| `4100 0000 0000 0010` | –õ—é–±–æ–π | ‚úÖ –£—Å–ø–µ—Ö |
| `5555 5555 5555 5599` | –õ—é–±–æ–π | ‚úÖ –£—Å–ø–µ—Ö (3DS) |
| `4111 1111 1111 1026` | –õ—é–±–æ–π | ‚ùå –û—Ç–∫–∞–∑ |

### –¢–µ—Å—Ç–æ–≤—ã–π —Ñ–ª–æ—É

1. **–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞:**
```bash
node index.js
```

2. **–ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ (–µ—Å–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ):**
```bash
node web/server.js
```

3. **Ngrok –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è webhook:**
```bash
ngrok http 3000
# –ü–æ–ª—É—á–∞–µ—Ç–µ URL: https://abc123.ngrok.io
# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç–µ webhook: https://abc123.ngrok.io/webhook/yookassa
```

4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ—Ç—É `/upgrade`
   - –ù–∞–∂–∞—Ç—å "–û–ø–ª–∞—Ç–∏—Ç—å 199 ‚ÇΩ"
   - –ü–µ—Ä–µ–π—Ç–∏ –ø–æ —Å—Å—ã–ª–∫–µ
   - –í–≤–µ—Å—Ç–∏ —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É `4100 0000 0000 0010`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ webhook
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç–∏–≤–∞—Ü–∏—é –ø–æ–¥–ø–∏—Å–∫–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

**–í –∫–æ–Ω—Å–æ–ª–∏ –±–æ—Ç–∞:**
```
üí≥ YooKassa: –°–æ–∑–¥–∞–Ω –ø–ª–∞—Ç—ë–∂ 2d97f526-... –¥–ª—è 123456789
   –°—Ç–∞—Ç—É—Å: pending
   –°—É–º–º–∞: 199.00 RUB
üì§ –°–æ–∑–¥–∞–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É –¥–ª—è 123456789
```

**–í –∫–æ–Ω—Å–æ–ª–∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞:**
```
üì• YooKassa webhook received
   Event: payment.succeeded
   Object ID: 2d97f526-...
üîç –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞ 2d97f526-...
üí∞ –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –Æ–ö–∞—Å—Å–∞:
   Payment ID: 2d97f526-...
   Chat ID: 123456789
   –°—É–º–º–∞: 199.00 RUB
‚úÖ Webhook –æ–±—Ä–∞–±–æ—Ç–∞–Ω —É—Å–ø–µ—à–Ω–æ
```

### SQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π

```sql
-- –í—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT * FROM payments WHERE chat_id = 123456789 ORDER BY created_at DESC;

-- –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–ª–∞—Ç—ë–∂
SELECT * FROM payments WHERE yookassa_payment_id = '2d97f526-...';

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
SELECT status, COUNT(*) FROM payments GROUP BY status;
```

---

## Troubleshooting

### Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç

**–ü—Ä–∏—á–∏–Ω—ã:**
1. –ù–µ–≤–µ—Ä–Ω—ã–π URL –≤ –õ–ö –Æ–ö–∞—Å—Å—ã
2. –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—Ç, firewall)
3. SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
curl -X POST https://your-domain.com/webhook/yookassa

# –õ–æ–≥–∏ nginx (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
tail -f /var/log/nginx/error.log

# –ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–ø—É—â–µ–Ω –ª–∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä
ps aux | grep node
```

### –ü–ª–∞—Ç—ë–∂ —Å–æ–∑–¥–∞—ë—Ç—Å—è, –Ω–æ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** `botInstance` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.

**–†–µ—à–µ–Ω–∏–µ:**

```javascript
// index.js
if (process.env.ENABLE_WEB === 'true') {
    const {setBotInstance} = require('./server');
    setBotInstance(bot);  // ‚Üê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —ç—Ç–æ
}
```

### –û—à–∏–±–∫–∞ "Bot instance not set"

–í –ª–æ–≥–∞—Ö webhook:
```
‚ùå Bot instance not set, cannot process payment
```

**–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `ENABLE_WEB=true` –≤ `.env`.

### –û—à–∏–±–∫–∞ 401 Unauthorized

```
‚ùå YooKassa createPayment error: Unauthorized
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω—ã–µ `YOOKASSA_SHOP_ID` –∏–ª–∏ `YOOKASSA_API_KEY`.

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ credentials –≤ `.env`.

### –ü–ª–∞—Ç—ë–∂ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã

**–ü—Ä–∏—á–∏–Ω–∞:** Webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑.

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞:
```javascript
if (paymentRecord.status === 'completed') {
    return true;  // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π webhook
}
```

---

## –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã

### –ß—Ç–æ —É–¥–∞–ª–µ–Ω–æ

- ‚ùå `PAYMENT_TOKEN` (Telegram Payments)
- ‚ùå `handlePreCheckoutQuery()`
- ‚ùå `handleSuccessfulPayment()`
- ‚ùå `bot.on('pre_checkout_query', ...)`
- ‚ùå –ü—Ä–æ–≤–µ—Ä–∫–∞ `msg.successful_payment`

### –ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ

- ‚úÖ `YooKassaService`
- ‚úÖ –ù–æ–≤—ã–µ –ø–æ–ª—è –≤ –ë–î: `yookassa_payment_id`, `confirmation_url`, `webhook_received_at`
- ‚úÖ Webhook endpoint: `POST /webhook/yookassa`
- ‚úÖ `handleYooKassaPaymentSuccess()`
- ‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: `YOOKASSA_SHOP_ID`, `YOOKASSA_API_KEY`, `BOT_USERNAME`

### –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–°—Ç–∞—Ä—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (—á–µ—Ä–µ–∑ Telegram Payments) –≤—Å—ë –µ—â—ë –≤ –ë–î:
- –ü–æ–ª–µ `payload` —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
- –ü–æ–ª–µ `telegram_payment_charge_id` —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
- –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –æ—Ç—á—ë—Ç –ø–æ —Å—Ç–∞—Ä—ã–º –ø–ª–∞—Ç–µ–∂–∞–º

### –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É

1. –û–±–Ω–æ–≤–∏—Ç–µ `.env`:
```bash
# –î–æ–±–∞–≤—å—Ç–µ
YOOKASSA_SHOP_ID=your_shop_id
YOOKASSA_API_KEY=your_api_key
BOT_USERNAME=your_bot_username

# –ú–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å (–Ω–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
# PAYMENT_TOKEN=...
```

2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ webhook –≤ –Æ–ö–∞—Å—Å–µ

3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:
```bash
pm2 restart aviasales-bot
# –∏–ª–∏
node index.js
```

4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –æ–ø–ª–∞—Ç—É

---

## FAQ

### –ú–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–∞ –º–µ—Ç–æ–¥–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ?

–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –¥–∞, –Ω–æ –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è. –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –º–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã.

### –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç—ã?

```javascript
// services/YooKassaService.js
async refundPayment(paymentId, amount) {
    const response = await this.client.post('/refunds', {
        payment_id: paymentId,
        amount: {
            value: amount.toFixed(2),
            currency: 'RUB'
        }
    }, {
        headers: {
            'Idempotence-Key': `refund_${paymentId}_${Date.now()}`
        }
    });

    return response.data;
}
```

### –ö–∞–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —á–∞—Å—Ç–∏—á–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏?

–ü–ª–∞—Ç–µ–∂–∏ —Å `capture: true` —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Å—Ä–∞–∑—É. –î–ª—è —á–∞—Å—Ç–∏—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `capture: false` –∏ –º–µ—Ç–æ–¥ `/payments/{id}/capture`.

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –ª–∏ —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω–∞—è –æ–ø–ª–∞—Ç–∞?

–î–∞, –Æ–ö–∞—Å—Å–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∏. –¢—Ä–µ–±—É–µ—Ç—Å—è:
1. –ü–µ—Ä–≤—ã–π –ø–ª–∞—Ç—ë–∂ —Å `save_payment_method: true`
2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `payment_method_id`
3. –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –ø–ª–∞—Ç–µ–∂–∏ —Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º –º–µ—Ç–æ–¥–æ–º

### –ö–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—Ç–º–µ–Ω—ã?

```javascript
if (notification.event === 'payment.canceled') {
    console.log(`üìõ –ü–ª–∞—Ç–µ–∂ –æ—Ç–º–µ–Ω–µ–Ω: ${notification.object.id}`);
    await _updatePaymentStatusByYookassaId(paymentId, 'canceled');
}
```

---

## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Æ–ö–∞—Å—Å–∞ API](https://yookassa.ru/developers/api)
- [–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ](https://yookassa.ru/developers/payment-acceptance/testing-and-going-live/testing)
- [Webhook](https://yookassa.ru/developers/using-api/webhooks)
- [–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å](https://yookassa.ru/developers/using-api/basics#idempotence)

---

## –õ–∏—Ü–µ–Ω–∑–∏—è

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Æ–ö–∞—Å—Å–∞ API –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∏—Ö [—É—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](https://yookassa.ru/docs/payment-acceptance/legal-aspects).

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:** 1.0
**–î–∞—Ç–∞:** 2026-02-06
**–ê–≤—Ç–æ—Ä:** Claude Code
