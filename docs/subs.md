# Подписки и уведомления

## Типы подписок

| | Free       | Plus     | Admin |
|---|------------|----------|---|
| Стоимость | Бесплатно  | 199 ₽/мес | — |
| Срок | Бессрочная | 1 месяц  | Бессрочная |
| Обычных маршрутов | 3          | 5        | ∞ |
| Гибких маршрутов | 1          | 3        | ∞ |
| Комбинаций в гибком | 20         | 50       | ∞ |
| Периодичность проверок | 2 часа     | 1 час    | 1 час |

При первом входе пользователя создаётся запись в `user_settings` и `user_subscriptions` (free по умолчанию).
При превышении лимитов — сообщение об исчерпании лимитов.

---

## Система уведомлений

### Приоритеты

| Приоритет | Условия срабатывания | Поведение |
|---|---|---|
| **CRITICAL** | Цена ≤ бюджету; исторический минимум; скидка ≥50% от средней | Всегда отправляется (даже при выкл. уведомлениях). Днём со звуком, ночью — тихо |
| **HIGH** | Перерасход бюджета ≤15%; скидка 30–50%; падение цены ≥15% за 24ч | Тихое уведомление. Free → дайджест, Plus → мгновенное (кулдаун 3ч на маршрут) |
| **MEDIUM** | Перерасход 15–30%; скидка 15–30%; падение 10–15% | Всегда в дайджест |
| **LOW** | Всё остальное | Только запись в лог, не отправляется |

### Уведомления по подпискам

| Фича | Free | Plus | Admin |
|---|---|---|---|
| CRITICAL мгновенные | До 3/день, потом в дайджест | Без лимита | Без лимита |
| HIGH мгновенные | Нет (→ дайджест) | Да (кулдаун 3ч) | Да |
| MEDIUM | Дайджест | Дайджест | — |
| Частота дайджеста | 1×/день (10:00) | 2×/день (10:00, 18:00) | Нет (всё мгновенно) |

### Ночной режим (23:00–08:00 по таймзоне пользователя)

- CRITICAL → отправляется тихо (без звука)
- HIGH, MEDIUM → откладываются в дайджест до утра

### Настройки пользователя (`user_settings`)

| Поле | По умолчанию | Описание |
|---|---|---|
| `notifications_enabled` | 1 | Мастер-переключатель (не влияет на CRITICAL) |
| `night_mode` | 1 | Тихий режим 23:00–08:00 |
| `digest_enabled` | 1 | Включить/выключить дайджест |
| `timezone` | Asia/Yekaterinburg | Таймзона пользователя |

### Таблицы БД

- `notification_log` — история всех отправленных уведомлений (хранение 30 дней)
- `daily_digest_queue` — очередь дайджеста (обработанные хранятся 7 дней)