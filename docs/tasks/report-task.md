# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è NotificationService - –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

NotificationService —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—É—é —Å–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å:
- **4 —É—Ä–æ–≤–Ω—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤**: CRITICAL, HIGH, MEDIUM, LOW
- **–ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** –ø–æ–¥ –∫–∞–∂–¥—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
- **Inline-–∫–Ω–æ–ø–∫–∏** –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –ø–æ–∫—É–ø–∫–µ
- **–î–∞–π–¥–∂–µ—Å—Ç—ã** –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- **–ù–æ—á–Ω–æ–π —Ä–µ–∂–∏–º** —Å –±–µ–∑–∑–≤—É—á–Ω—ã–º–∏ CRITICAL-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
- **–õ–∏–º–∏—Ç—ã** –¥–ª—è Free –ø–æ–¥–ø–∏—Å–∫–∏ (3 CRITICAL –≤ –¥–µ–Ω—å)
- **Cooldown** –¥–ª—è HIGH —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—Ä–∞–∑ –≤ 3 —á–∞—Å–∞ –¥–ª—è Plus)

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `notification_log`
```sql
CREATE TABLE IF NOT EXISTS notification_log (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  chat_id INTEGER NOT NULL,
  route_id INTEGER,
  priority TEXT NOT NULL,        -- 'CRITICAL', 'HIGH', 'MEDIUM', 'LOW'
  price REAL,
  message_type TEXT NOT NULL,    -- 'instant', 'digest', 'report'
  sent_at DATETIME DEFAULT (datetime('now')),
  disable_notification INTEGER DEFAULT 0
);
```

### –¢–∞–±–ª–∏—Ü–∞ `daily_digest_queue`
```sql
CREATE TABLE IF NOT EXISTS daily_digest_queue (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  chat_id INTEGER NOT NULL,
  route_id INTEGER NOT NULL,
  priority TEXT NOT NULL,
  price REAL NOT NULL,
  avg_price REAL,
  historical_min REAL,
  best_result_id INTEGER,
  created_at DATETIME DEFAULT (datetime('now')),
  processed INTEGER DEFAULT 0
);
```

---

## –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤

### –ú–µ—Ç–æ–¥: `classifyPriority(routeData)`

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```javascript
{
  priority: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW',
  reasons: string[]
}
```

### –õ–æ–≥–∏–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤

#### CRITICAL
- –¶–µ–Ω–∞ <= –±—é–¥–∂–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –¶–µ–Ω–∞ = –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –º–∏–Ω–∏–º—É–º
- –°–∫–∏–¥–∫–∞ >= 50% –æ—Ç —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã

#### HIGH
- –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞ <= 15%
- –°–∫–∏–¥–∫–∞ 30-49% –æ—Ç —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã
- –ü–∞–¥–µ–Ω–∏–µ >= 15% –∑–∞ 24—á

#### MEDIUM
- –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞ 15-30%
- –°–∫–∏–¥–∫–∞ 15-29% –æ—Ç —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã
- –ü–∞–¥–µ–Ω–∏–µ 10-14% –∑–∞ 24—á

#### LOW
- –í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ

---

## –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### –ú–µ—Ç–æ–¥: `processAndRouteNotification(...)`

**–õ–æ–≥–∏–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞:**

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ù–æ—á—å—é | Free –ø–æ–¥–ø–∏—Å–∫–∞ | Plus –ø–æ–¥–ø–∏—Å–∫–∞ |
|-----------|-------|---------------|---------------|
| **CRITICAL** | –ë–µ–∑–∑–≤—É—á–Ω–æ | –ú–∞–∫—Å 3/–¥–µ–Ω—å, –∑–∞—Ç–µ–º ‚Üí –¥–∞–π–¥–∂–µ—Å—Ç | –ë–µ–∑ –ª–∏–º–∏—Ç–∞, —Å–æ –∑–≤—É–∫–æ–º |
| **HIGH** | ‚Üí –î–∞–π–¥–∂–µ—Å—Ç | ‚Üí –î–∞–π–¥–∂–µ—Å—Ç | –†–∞–∑ –≤ 3—á (–±–µ–∑–∑–≤—É—á–Ω–æ), –∑–∞—Ç–µ–º ‚Üí –¥–∞–π–¥–∂–µ—Å—Ç |
| **MEDIUM** | ‚Üí –î–∞–π–¥–∂–µ—Å—Ç | ‚Üí –î–∞–π–¥–∂–µ—Å—Ç | ‚Üí –î–∞–π–¥–∂–µ—Å—Ç |
| **LOW** | –¢–∏—Ö–æ | –¢–∏—Ö–æ | –¢–∏—Ö–æ |

**–ù–æ—á–Ω–æ–µ –≤—Ä–µ–º—è:** 23:00 - 08:00

---

## –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### CRITICAL: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ–¥–∞—é—â–∏–π —Ñ–æ—Ä–º–∞—Ç

```
üî•üî•üî• –°–£–ü–ï–† –¶–ï–ù–ê! üî•üî•üî•

<b>–ì–æ—Ä–æ–¥ ‚Üí –ì–æ—Ä–æ–¥</b>
üìÖ –¥–¥.–º–º‚Äì–¥–¥.–º–º (N –¥–Ω–µ–π)
üë• X –≤–∑—Ä–æ—Å–ª—ã—Ö [+ Y –¥–µ—Ç–µ–π]

üíé <b>XXX XXX ‚ÇΩ</b> –∑–∞ –≤—Å–µ—Ö

<b>üí∞ –≠–∫–æ–Ω–æ–º–∏—è XX XXX ‚ÇΩ (-XX%)</b>

üéØ –í–∞—à –±—é–¥–∂–µ—Ç: XXX XXX ‚ÇΩ [‚úÖ –∏–ª–∏ (+X%)]
üìä –û–±—ã—á–Ω–∞—è —Ü–µ–Ω–∞: XXX XXX ‚ÇΩ

‚úàÔ∏è –ê–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏—è -  –¢–∏–ø —Ä–µ–π—Å–∞ -  üß≥

‚ö°Ô∏è <b>–¶–µ–Ω–∞ –º–æ–∂–µ—Ç –≤—ã—Ä–∞—Å—Ç–∏ –≤ –±–ª–∏–∂–∞–π—à–∏–µ —á–∞—Å—ã</b>

[üé´ –ö–£–ü–ò–¢–¨ –°–ï–ô–ß–ê–°] ‚Üê inline-–∫–Ω–æ–ø–∫–∞
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –Ø—Ä–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å —Ç—Ä–µ–º—è –æ–≥–Ω—è–º–∏
- –ö—Ä—É–ø–Ω–∞—è —Ü–µ–Ω–∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –º–∞—Ä—à—Ä—É—Ç–∞
- –ê–∫—Ü–µ–Ω—Ç –Ω–∞ —ç–∫–æ–Ω–æ–º–∏–∏ –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º
- –≠–ª–µ–º–µ–Ω—Ç —Å—Ä–æ—á–Ω–æ—Å—Ç–∏ –≤–Ω–∏–∑—É
- Inline-–∫–Ω–æ–ø–∫–∞ "–ö–£–ü–ò–¢–¨ –°–ï–ô–ß–ê–°"

### HIGH: –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç

```
üìä –•–æ—Ä–æ—à–∞—è —Ü–µ–Ω–∞ –Ω–∞–π–¥–µ–Ω–∞ -  –ß–ß:–ú–ú

<b>–ì–æ—Ä–æ–¥ ‚Üí –ì–æ—Ä–æ–¥</b>
üìÖ –¥–¥.–º–º‚Äì–¥–¥.–º–º (N –¥–Ω–µ–π)
üë• X+Y -  –ü–µ—Ä–µ—Å–∞–¥–∫–∏ -  üß≥

üí∞ <b>XXX XXX ‚ÇΩ</b> –∑–∞ –≤—Å–µ—Ö

–í–∞—à –±—é–¥–∂–µ—Ç: XXX XXX ‚ÇΩ [(+X%) –∏–ª–∏ ‚úÖ]
–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: XXX XXX ‚ÇΩ [(-X%)]

‚úàÔ∏è –ê–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏—è

üí° –ü—Ä–æ–¥–æ–ª–∂–∞—é –∏—Å–∫–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤ –±—é–¥–∂–µ—Ç–µ

[üé´ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –±–∏–ª–µ—Ç] ‚Üê inline-–∫–Ω–æ–ø–∫–∞
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º
- –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞—Å—Å–∞–∂–∏—Ä–∞—Ö
- –î–≤–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (–±—é–¥–∂–µ—Ç –∏ —Å—Ä–µ–¥–Ω—è—è)
- –£—Å–ø–æ–∫–∞–∏–≤–∞—é—â–µ–µ "–ü—Ä–æ–¥–æ–ª–∂–∞—é –∏—Å–∫–∞—Ç—å"
- –û–±—ã—á–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –±–µ–∑ CAPS LOCK

### MEDIUM/LOW: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç

```
üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ -  –ß–ß:–ú–ú

<b>–ì–æ—Ä–æ–¥ ‚Üí –ì–æ—Ä–æ–¥</b>
üìÖ –¥–¥.–º–º‚Äì–¥–¥.–º–º
üë• X+Y

–¶–µ–Ω–∞: XXX XXX ‚ÇΩ
–í–∞—à –±—é–¥–∂–µ—Ç: XXX XXX ‚ÇΩ [(–ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –≤ X —Ä–∞–∑–∞) –∏–ª–∏ (+X%)]

–ü—Ä–æ–¥–æ–ª–∂–∞—é –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ üîé
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ú–∏–Ω–∏–º—É–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- –¢–æ–ª—å–∫–æ —Ü–µ–Ω–∞ –∏ –±—é–¥–∂–µ—Ç
- –ù–µ—Ç –ø—Ä–∏–∑—ã–≤–æ–≤ –∫ –ø–æ–∫—É–ø–∫–µ
- –§–æ–∫—É—Å –Ω–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞

### –ù–µ—Ç —Ü–µ–Ω

```
üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ -  –ß–ß:–ú–ú

<b>–ì–æ—Ä–æ–¥ ‚Üí –ì–æ—Ä–æ–¥</b>
‚ùå –¶–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
–í–∞—à –±—é–¥–∂–µ—Ç: XXX XXX ‚ÇΩ

–°–µ–π—á–∞—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–æ X –ø—Ä–æ–≤–µ—Ä–æ–∫. –í—Å–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–æ–∫ Y

–ü—Ä–æ–¥–æ–ª–∂–∞—é –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ üîç
```

---

## Inline-–∫–Ω–æ–ø–∫–∏

### –û–¥–∏–Ω–æ—á–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

–ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–∫—Ä–µ–ø–ª—è–µ—Ç—Å—è –∫ —Å–æ–æ–±—â–µ–Ω–∏—é —á–µ—Ä–µ–∑ `reply_markup`:

```javascript
const sendOpts = {
  parse_mode: 'HTML',
  disable_notification: silent,
  reply_markup: {
    inline_keyboard: [[
      { 
        text: priority === 'CRITICAL' ? 'üé´ –ö–£–ü–ò–¢–¨ –°–ï–ô–ß–ê–°' : 'üé´ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –±–∏–ª–µ—Ç',
        url: bestResult.search_link 
      }
    ]]
  }
};
```

### –°–≤–æ–¥–Ω—ã–π –æ—Ç—á—ë—Ç

–ö–Ω–æ–ø–∫–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ (–º–∞–∫—Å–∏–º—É–º 10):

```javascript
const buttons = [];
for (const rb of routeBlocks) {
  if (rb.block.searchLink && buttons.length < 10) {
    const routeName = airportResolver.formatRoute(rb.route.origin, rb.route.destination);
    buttons.push([{
      text: `üîó ${routeName} ‚Äî –°–º–æ—Ç—Ä–µ—Ç—å ‚Üí`,
      url: rb.block.searchLink
    }]);
  }
}

opts.reply_markup = { inline_keyboard: buttons };
```

–ö–Ω–æ–ø–∫–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —á–∞–Ω–∫—É.

---

## –°–≤–æ–¥–Ω—ã–π –æ—Ç—á—ë—Ç

### –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ —Å —Å–∞–º–æ–ª—ë—Ç–æ–º

–í–º–µ—Å—Ç–æ —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö –ª–∏–Ω–∏–π `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å–∞–º–æ–ª—ë—Ç:

```javascript
const generatePlaneLine = (position, totalSteps) => {
  const LINE_LENGTH = 20;
  const planePos = Math.round((position / totalSteps) * LINE_LENGTH);
  const left = '‚îÄ'.repeat(planePos);
  const right = '‚îÄ'.repeat(LINE_LENGTH - planePos);
  return `<b>${left}‚úà${right}</b>`;
};
```

**–ü—Ä–∏–º–µ—Ä—ã:**
- 0 –∏–∑ 3: `<b>‚úà‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</b>`
- 1 –∏–∑ 3: `<b>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚úà‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</b>`
- 2 –∏–∑ 3: `<b>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚úà‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</b>`
- 3 –∏–∑ 3: `<b>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚úà</b>`

### –ó–∞–≥–æ–ª–æ–≤–æ–∫

```
üî• –û—Ç–ª–∏—á–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏! -  –ß–ß:–ú–ú    (–µ—Å–ª–∏ –µ—Å—Ç—å CRITICAL)
üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ -  –ß–ß:–ú–ú   (–æ–±—ã—á–Ω–∞—è)

<b>‚úà‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</b>
```

### –ü–æ–¥–≤–∞–ª

```
<b>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚úà</b>

–û—Ç–ª–∏—á–Ω—ã–µ —Ü–µ–Ω—ã! –ù–µ —É–ø—É—Å—Ç–∏ üéØ     (–µ—Å–ª–∏ –µ—Å—Ç—å –Ω–∞—Ö–æ–¥–∫–∏)
–ü—Ä–æ–¥–æ–ª–∂–∞—é –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ üîç         (–µ—Å–ª–∏ –Ω–∞—Ö–æ–¥–æ–∫ –Ω–µ—Ç)
```

---

## –î–∞–π–¥–∂–µ—Å—Ç

### –ú–µ—Ç–æ–¥: `sendDigestForUser(chatId)`

**–ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:**
- Free: 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å –≤ 10:00
- Plus: 2 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å –≤ 10:00 –∏ 18:00

**–õ–æ–≥–∏–∫–∞:**
1. –ü–æ–ª—É—á–∏—Ç—å –Ω–µ–ø—Ä–æ—Ü–µ—Å—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ `daily_digest_queue`
2. –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (CRITICAL ‚Üí HIGH ‚Üí MEDIUM ‚Üí LOW)
3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫
4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ `sendConsolidatedReport()`
5. –ü–æ–º–µ—Ç–∏—Ç—å `processed = 1`

**–ó–≤—É–∫:** –í—Å–µ–≥–¥–∞ –±–µ–∑–∑–≤—É—á–Ω–æ

---

## –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏

### –ö–æ—Ä–æ—Ç–∫–∞—è –¥–∞—Ç–∞
```javascript
_formatShortDateForProgressBar(dateStr) // ‚Üí "1.05", "25.12"
```

### –î–ª–∏–Ω–Ω–∞—è –¥–∞—Ç–∞
```javascript
_formatShortDateRu(dateStr) // ‚Üí "1 –º–∞—è", "25 –¥–µ–∫–∞–±—Ä—è"
```

### –í—Ä–µ–º—è
```javascript
_formatTimeForUser(date, timezone) // ‚Üí "16:52"
```

### –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ –¥–Ω–µ–π
```javascript
_pluralizeDays(7)  // ‚Üí "–¥–Ω–µ–π"
_pluralizeDays(1)  // ‚Üí "–¥–µ–Ω—å"
_pluralizeDays(22) // ‚Üí "–¥–Ω—è"
```

---

## –†–∞–∑–±–∏–µ–Ω–∏–µ –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

### –ú–µ—Ç–æ–¥: `_splitMessage(text, maxLength)`

Telegram –ª–∏–º–∏—Ç: 4096 —Å–∏–º–≤–æ–ª–æ–≤

**–õ–æ–≥–∏–∫–∞:**
1. –ï—Å–ª–∏ –¥–ª–∏–Ω–∞ <= 4000 ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
2. –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º
3. –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –≤ —á–∞–Ω–∫–∏
4. Inline-–∫–Ω–æ–ø–∫–∏ —Ç–æ–ª—å–∫–æ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —á–∞–Ω–∫—É

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –¢–∞–±–ª–∏—Ü–∞ `user_settings`

```sql
night_mode INTEGER DEFAULT 1
notifications_enabled INTEGER DEFAULT 1
digest_enabled INTEGER DEFAULT 1
timezone TEXT DEFAULT 'Asia/Yekaterinburg'
```

### –ù–æ—á–Ω–æ–π —Ä–µ–∂–∏–º

```javascript
_isNightTime(timezone, settings) // 23:00 - 08:00
```

---

## –ü–æ–ª–Ω—ã–π workflow

```
1. scheduler.js: checkUserRoutes(chatId)
   ‚Üì
2. UnifiedMonitor.checkSingleRoute(route)
   ‚Üí –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
   ‚Üì
3. NotificationService.getRouteAnalytics(routeId)
   NotificationService.getPriceDropPercent(routeId, currentPrice)
   ‚Üì
4. NotificationService.classifyPriority(routeData)
   ‚Üí { priority: 'CRITICAL', reasons: [...] }
   ‚Üì
5. NotificationService.processAndRouteNotification(...)
   ‚Üí –†–µ—à–µ–Ω–∏–µ: 'sent', 'sent_silent', 'digest', 'skipped', 'silent'
   ‚Üì
6a. –ï—Å–ª–∏ 'sent'/'sent_silent':
    formatSingleRouteBlock(..., priority)
    ‚Üí _sendInstantAlert(...) —Å inline-–∫–Ω–æ–ø–∫–æ–π

6b. –ï—Å–ª–∏ 'digest':
    ‚Üí _addToDigestQueue(...)

6c. –ï—Å–ª–∏ 'skipped'/'silent':
    ‚Üí –ù–∏—á–µ–≥–æ
```

---

## –ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏

### –£–±—Ä–∞–Ω–æ
- ‚ùå –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã `[‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë]`
- ‚ùå –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã üü¢/üî¥ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–æ–π
- ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã –≤ —Ä–∞—Å—á—ë—Ç–∞—Ö
- ‚ùå –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Å—Å—ã–ª–∫–∏ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞
- ‚ùå –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≤—Å–µ—Ö –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤

### –î–æ–±–∞–≤–ª–µ–Ω–æ
- ‚úÖ –†–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–ª—è CRITICAL/HIGH/MEDIUM/LOW
- ‚úÖ Inline-–∫–Ω–æ–ø–∫–∏ –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å—Å—ã–ª–æ–∫
- ‚úÖ –≠–ª–µ–º–µ–Ω—Ç—ã —Å—Ä–æ—á–Ω–æ—Å—Ç–∏ –¥–ª—è CRITICAL
- ‚úÖ –ê–∫—Ü–µ–Ω—Ç –Ω–∞ —ç–∫–æ–Ω–æ–º–∏–∏ –≤ —Ä—É–±–ª—è—Ö
- ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å–∞–º–æ–ª—ë—Ç –≤ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è—Ö
- ‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫
- ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –ø–æ–¥–≤–∞–ª—ã

### –ü—Å–∏—Ö–æ–ª–æ–≥–∏—è
- **CRITICAL**: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –º–æ—Ç–∏–≤–∞—Ü–∏—è –∫ –ø–æ–∫—É–ø–∫–µ, —Å—Ä–æ—á–Ω–æ—Å—Ç—å
- **HIGH**: –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ, –±–µ–∑ –ø–∞–Ω–∏–∫–∏
- **MEDIUM/LOW**: –ú–∏–Ω–∏–º—É–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, —Ñ–æ–∫—É—Å –Ω–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞
