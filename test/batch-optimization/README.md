# –¢–µ—Å—Ç—ã batch-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

–ù–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã batch-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

### Unit-—Ç–µ—Å—Ç—ã (–±—ã—Å—Ç—Ä—ã–µ, –±–µ–∑ API –∑–∞–ø—Ä–æ—Å–æ–≤)

1. **01-unit-prepareBatchItem.test.js** - —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç –º–µ—Ç–æ–¥ `prepareBatchItem()`
   - –û–±—ã—á–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç (1 –∫–æ–º–±–∏–Ω–∞—Ü–∏—è)
   - –ì–∏–±–∫–∏–π –º–∞—Ä—à—Ä—É—Ç (–º–Ω–æ–≥–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π)
   - –ü—É—Å—Ç–æ–π –º–∞—Ä—à—Ä—É—Ç (0 –∫–æ–º–±–∏–Ω–∞—Ü–∏–π)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤

2. **02-unit-processBatchResults.test.js** - —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç –º–µ—Ç–æ–¥ `processBatchResults()`
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –ë–î
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ "–Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü (route_results, route_check_stats, combination_check_results, price_analytics)

### Integration-—Ç–µ—Å—Ç—ã (–º–µ–¥–ª–µ–Ω–Ω—ã–µ, —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ API –∑–∞–ø—Ä–æ—Å–∞–º–∏)

3. **03-integration-batch30.test.js** - —Ç–µ—Å—Ç batch –∏–∑ 30 –º–∞—Ä—à—Ä—É—Ç–æ–≤
   - –°–æ–∑–¥–∞–µ—Ç 3 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è √ó 10 –º–∞—Ä—à—Ä—É—Ç–æ–≤
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–ª–Ω—É—é batch-–ø—Ä–æ–≤–µ—Ä–∫—É
   - –ò–∑–º–µ—Ä—è–µ—Ç –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

4. **04-integration-filters.test.js** - —Ç–µ—Å—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
   - –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç—ã —Å —Ä–∞–∑–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ (airline, baggage, max_stops, max_layover_hours)
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –∫–∞–∂–¥—ã–π –º–∞—Ä—à—Ä—É—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å–æ —Å–≤–æ–∏–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
   - –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ü–µ–Ω—ã (–æ–∂–∏–¥–∞–µ—Ç—Å—è —Ä–∞–∑–ª–∏—á–∏–µ)

## –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

### –í—Å–µ unit-—Ç–µ—Å—Ç—ã
```bash
node test/batch-optimization/01-unit-prepareBatchItem.test.js
node test/batch-optimization/02-unit-processBatchResults.test.js
```

### Integration-—Ç–µ—Å—Ç—ã (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ - —Ä–µ–∞–ª—å–Ω—ã–µ API –∑–∞–ø—Ä–æ—Å—ã!)

‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï:** Integration-—Ç–µ—Å—Ç—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ Aviasales API –∏ –º–æ–≥—É—Ç –∑–∞–Ω—è—Ç—å 1-2 –º–∏–Ω—É—Ç—ã.

```bash
# –¢–µ—Å—Ç 30 –º–∞—Ä—à—Ä—É—Ç–æ–≤ (~30-60 —Å–µ–∫—É–Ω–¥)
node test/batch-optimization/03-integration-batch30.test.js

# –¢–µ—Å—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ (~20-40 —Å–µ–∫—É–Ω–¥)
node test/batch-optimization/04-integration-filters.test.js
```

### –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
```bash
# Unit-—Ç–µ—Å—Ç—ã
npm run test:batch:unit

# Integration-—Ç–µ—Å—Ç—ã
npm run test:batch:integration

# –í—Å–µ —Ç–µ—Å—Ç—ã
npm run test:batch
```

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Node.js 14+
- .env —Ñ–∞–π–ª —Å TELEGRAM_BOT_TOKEN –∏ TRAVELPAYOUTS_TOKEN
- SQLite –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (data/bot.db)
- –ò–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (–¥–ª—è integration-—Ç–µ—Å—Ç–æ–≤)

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤

### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

**Unit-—Ç–µ—Å—Ç—ã:**
- ‚úÖ –í—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∑–∞ < 5 —Å–µ–∫—É–Ω–¥
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è—é—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ API –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –°–æ–∑–¥–∞—é—Ç –∏ –æ—á–∏—â–∞—é—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î

**Integration-—Ç–µ—Å—Ç—ã:**
- ‚úÖ Batch –∏–∑ 30 –º–∞—Ä—à—Ä—É—Ç–æ–≤: ~30-60 —Å–µ–∫—É–Ω–¥
- ‚úÖ –ü—Ä–∏—Ä–æ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: 5-10x –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
- ‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î
- ‚úÖ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

- [ ] –í—Å–µ unit-—Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] Integration-—Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] –í—Ä–µ–º—è batch-–ø—Ä–æ–≤–µ—Ä–∫–∏ 30 –º–∞—Ä—à—Ä—É—Ç–æ–≤ < 120 —Å–µ–∫—É–Ω–¥
- [ ] –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤–æ –≤—Å–µ –Ω—É–∂–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –ë–î
- [ ] –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ù–µ—Ç —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏ –∏–ª–∏ –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

## –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏

–í—Å–µ —Ç–µ—Å—Ç—ã –≤—ã–≤–æ–¥—è—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏:
- üß™ - –Ω–∞—á–∞–ª–æ —Ç–µ—Å—Ç–∞
- ‚úÖ - —É—Å–ø–µ—à–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
- ‚ùå - –ø—Ä–æ–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏
- ‚ö†Ô∏è - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
- üìä - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤

```bash
sqlite3 data/bot.db "SELECT COUNT(*) FROM unified_routes WHERE chat_id BETWEEN 99990 AND 99999"
```

–ï—Å–ª–∏ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤ –æ—Å—Ç–∞–ª–∏—Å—å –¥–∞–Ω–Ω—ã–µ - —Ç–µ—Å—Ç—ã –Ω–µ –æ—á–∏—Å—Ç–∏–ª–∏ –∑–∞ —Å–æ–±–æ–π. –†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞:

```bash
sqlite3 data/bot.db "DELETE FROM unified_routes WHERE chat_id BETWEEN 99990 AND 99999"
```

### –ü—Ä–æ–±–ª–µ–º—ã —Å API

–ï—Å–ª–∏ —Ç–µ—Å—Ç—ã –ø–∞–¥–∞—é—Ç —Å –æ—à–∏–±–∫–∞–º–∏ API:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ TRAVELPAYOUTS_TOKEN –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –Ω–µ—Ç –ª–∏–º–∏—Ç–æ–≤ API
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –ø—Ä–æ–∫—Å–∏ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è)

## CI/CD

–î–ª—è CI/CD —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ unit-—Ç–µ—Å—Ç—ã (–±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö API –∑–∞–ø—Ä–æ—Å–æ–≤):

```yaml
# .github/workflows/test.yml
test:
  run: |
    node test/batch-optimization/01-unit-prepareBatchItem.test.js
    node test/batch-optimization/02-unit-processBatchResults.test.js
```

Integration-—Ç–µ—Å—Ç—ã –ª—É—á—à–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (—Ä–∞–∑ –≤ –¥–µ–Ω—å).

## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è batch-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏](../../docs/batch-optimization.md)
- [–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é](../../docs/batch-optimization-testing.md)
