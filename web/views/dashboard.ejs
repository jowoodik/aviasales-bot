<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Aviasales Bot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }
        .header p {
            opacity: 0.9;
            margin-top: 5px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .stat-card .icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        .stat-card .value {
            font-size: 2.2em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        .stat-card .label {
            color: #666;
            font-size: 0.9em;
        }
        .stat-card.savings {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        .stat-card.savings .value {
            color: white;
        }
        .stat-card.savings .label {
            color: rgba(255,255,255,0.9);
        }
        .section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        .section h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .route-card {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .route-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-color: #667eea;
        }
        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .route-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }
        .route-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        .status-paused {
            background: #fff3cd;
            color: #856404;
        }
        .price-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .price-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .price-label {
            font-size: 0.85em;
            color: #666;
            font-weight: 500;
        }
        .price-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }
        .price-value.best {
            color: #28a745;
        }
        .price-value.threshold {
            color: #667eea;
        }
        .price-value.savings {
            color: #ff6b6b;
        }
        .route-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 0.95em;
        }
        .route-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            font-weight: 500;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .empty-state {
            text-align: center;
            padding: 50px;
            color: #999;
        }
        .empty-state i {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        .last-check {
            font-size: 0.85em;
            color: #999;
            margin-top: 5px;
        }
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 8px;
        }
        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            overflow-y: auto;
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: white;
            margin: 20px;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 {
            margin: 0;
            font-size: 1.5em;
        }
        .close {
            color: white;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        .close:hover {
            opacity: 0.7;
        }
        .modal-body {
            padding: 30px;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –±–∏–ª–µ—Ç–æ–≤ */
        .ticket-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            background: white;
        }
        .ticket-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }
        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .ticket-price {
            font-size: 2em;
            font-weight: bold;
            color: #28a745;
        }
        .ticket-airline {
            font-size: 1.1em;
            color: #666;
            font-weight: 500;
        }
        .ticket-date {
            color: #999;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .ticket-link {
            display: inline-block;
            margin-top: 10px;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.3s;
        }
        .ticket-link:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        /* –ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω */
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .history-price {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }
        .history-details {
            color: #666;
            font-size: 0.9em;
        }
        .price-trend {
            font-size: 0.9em;
            font-weight: bold;
        }
        .price-trend.up {
            color: #dc3545;
        }
        .price-trend.down {
            color: #28a745;
        }

        @media (max-width: 768px) {
            .route-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .modal-content {
                width: 95%;
                margin: 10px;
            }
        }
    </style>
</head>
<body>
<div class="header">
    <div class="container">
        <h1>‚úàÔ∏è Dashboard</h1>
        <p>Chat ID: <%= chatId %></p>
        <% if (stats.lastCheckTime) { %>
            <p style="font-size: 0.9em; opacity: 0.8;">
                –ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞:
                <script>
                  (function() {
                    function formatTimeAgo(dateString) {
                      if (!dateString) return '';
                      const utcDate = new Date(dateString + 'Z');
                      const options = {
                        day: 'numeric',
                        month: 'short',
                        hour: '2-digit',
                        minute: '2-digit',
                        timeZone: 'Asia/Yekaterinburg',
                        hour12: false
                      };
                      return utcDate.toLocaleString('ru-RU', options);
                    }
                    document.write(formatTimeAgo('<%= stats.lastCheckTime %>'));
                  })();
                </script>
            </p>
        <% } %>
    </div>
</div>

<div class="container">
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="icon">‚úàÔ∏è</div>
            <div class="value"><%= routes.length %></div>
            <div class="label">–û–±—ã—á–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤</div>
            <% if (stats.activeRoutes !== undefined) { %>
                <div class="last-check">–ê–∫—Ç–∏–≤–Ω—ã—Ö: <%= stats.activeRoutes %></div>
            <% } %>
        </div>
        <div class="stat-card">
            <div class="icon">üîç</div>
            <div class="value"><%= flexRoutes.length %></div>
            <div class="label">–ì–∏–±–∫–∏—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤</div>
            <% if (stats.activeFlexRoutes !== undefined) { %>
                <div class="last-check">–ê–∫—Ç–∏–≤–Ω—ã—Ö: <%= stats.activeFlexRoutes %></div>
            <% } %>
        </div>
        <div class="stat-card">
            <div class="icon">üìä</div>
            <div class="value"><%= stats.total_prices || 0 %></div>
            <div class="label">–ü—Ä–æ–≤–µ—Ä–æ–∫ —Ü–µ–Ω</div>
        </div>
        <div class="stat-card savings">
            <div class="icon">üí∞</div>
            <div class="value"><%= stats.totalSavings ? Math.floor(stats.totalSavings).toLocaleString('ru-RU') : 0 %></div>
            <div class="label">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è (‚ÇΩ)</div>
        </div>
    </div>

    <!-- –û–±—ã—á–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã -->
    <div class="section">
        <h2><i class="fas fa-plane"></i> –û–±—ã—á–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã</h2>
        <% if (routes.length === 0) { %>
            <div class="empty-state">
                <i class="fas fa-plane-slash"></i>
                <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ–±—ã—á–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤</p>
            </div>
        <% } else { %>
            <% routes.forEach(route => { %>
                <div class="route-card">
                    <div class="route-header">
                        <div class="route-title">
                            <%= route.origin %> ‚Üí <%= route.destination %>
                            <% if (route.savings > 0) { %>
                                <span class="badge badge-success">üíé -<%= Math.floor(route.savings).toLocaleString('ru-RU') %> ‚ÇΩ</span>
                            <% } %>
                        </div>
                        <span class="route-status <%= route.is_paused ? 'status-paused' : 'status-active' %>">
                                <%= route.is_paused ? '‚è∏Ô∏è –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' %>
                            </span>
                    </div>

                    <!-- –ë–ª–æ–∫ —Ü–µ–Ω -->
                    <div class="price-section">
                        <div class="price-item">
                            <div class="price-label">üíé –õ—É—á—à–∞—è —Ü–µ–Ω–∞</div>
                            <div class="price-value best">
                                <%= route.bestPrice ? Math.floor(route.bestPrice.price).toLocaleString('ru-RU') + ' ‚ÇΩ' : '‚Äî' %>
                            </div>
                            <% if (route.bestPrice) { %>
                                <div class="last-check">
                                    <%= route.bestPrice.airline %> |
                                    <script>
                                      document.write((function(){
                                        return new Date('<%= route.bestPrice.found_at %>').toLocaleDateString('ru-RU');
                                      })());
                                    </script>
                                </div>
                            <% } %>
                        </div>
                        <div class="price-item">
                            <div class="price-label">üéØ –í–∞—à –ø–æ—Ä–æ–≥</div>
                            <div class="price-value threshold">
                                <%= route.threshold_price.toLocaleString('ru-RU') %> ‚ÇΩ
                            </div>
                        </div>
                        <div class="price-item">
                            <div class="price-label">üìâ –ü–æ—Å–ª–µ–¥–Ω—è—è</div>
                            <div class="price-value">
                                <%= route.lastCheck ? Math.floor(route.lastCheck.price).toLocaleString('ru-RU') + ' ‚ÇΩ' : '‚Äî' %>
                            </div>
                            <% if (route.lastCheck) { %>
                                <div class="last-check">
                                    <script>
                                      document.write((function(){
                                        const d = new Date('<%= route.lastCheck.found_at %>Z');
                                        return d.toLocaleString('ru-RU', {
                                          month: 'short',
                                          day: 'numeric',
                                          hour: '2-digit',
                                          minute: '2-digit',
                                          timeZone: 'Asia/Yekaterinburg',
                                          hour12: false
                                        });
                                      })());
                                    </script>
                                </div>
                            <% } %>
                        </div>
                        <% if (route.savings > 0) { %>
                            <div class="price-item">
                                <div class="price-label">üí∞ –≠–∫–æ–Ω–æ–º–∏—è</div>
                                <div class="price-value savings">
                                    <%= Math.floor(route.savings).toLocaleString('ru-RU') %> ‚ÇΩ
                                </div>
                                <div class="last-check">
                                    <%= Math.floor((route.savings / route.threshold_price) * 100) %>% –æ—Ç –ø–æ—Ä–æ–≥–∞
                                </div>
                            </div>
                        <% } %>
                    </div>

                    <div class="route-info">
                        <div class="info-item">
                            <i class="fas fa-calendar"></i>
                            <span>
                              <script>
                                document.write((function(){
                                  return new Date('<%= route.departure_date %>').toLocaleDateString('ru-RU');
                                })());
                              </script>
                              -
                              <script>
                                document.write((function(){
                                  return new Date('<%= route.return_date %>').toLocaleDateString('ru-RU');
                                })());
                              </script>
                            </span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-users"></i>
                            <span><%= route.adults %> –≤–∑—Ä<%= route.children > 0 ? ', ' + route.children + ' –¥–µ—Ç' : '' %></span>
                        </div>
                        <% if (route.airline) { %>
                            <div class="info-item">
                                <i class="fas fa-plane"></i>
                                <span><%= route.airline %></span>
                            </div>
                        <% } %>
                        <div class="info-item">
                            <i class="fas fa-suitcase"></i>
                            <span><%= route.baggage ? '–° –±–∞–≥–∞–∂–æ–º' : '–ë–µ–∑ –±–∞–≥–∞–∂–∞' %></span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-clock"></i>
                            <span>–ú–∞–∫—Å. –ø–µ—Ä–µ—Å–∞–¥–∫–∞: <%= route.max_layover_hours || 5 %>—á</span>
                        </div>
                    </div>

                    <div class="route-actions">
                        <button class="btn btn-success" onclick="showTickets(<%= route.id %>, 'regular')">
                            üé´ –õ—É—á—à–∏–µ –±–∏–ª–µ—Ç—ã
                        </button>
                        <button class="btn btn-info" onclick="showHistory(<%= route.id %>, 'regular')">
                            üìä –ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω
                        </button>
                        <button class="btn btn-primary" onclick="togglePause(<%= route.id %>, <%= route.is_paused ? 1 : 0 %>, 'regular')">
                            <%= route.is_paused ? '‚ñ∂Ô∏è –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å' : '‚è∏Ô∏è –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å' %>
                        </button>
                        <button class="btn btn-warning" onclick="editThreshold(<%= route.id %>, <%= route.threshold_price %>, 'regular')">
                            üí∞ –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä–æ–≥
                        </button>
                        <button class="btn btn-danger" onclick="deleteRoute(<%= route.id %>, 'regular')">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            <% }) %>
        <% } %>
    </div>

    <!-- –ì–∏–±–∫–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã -->
    <div class="section">
        <h2><i class="fas fa-search"></i> –ì–∏–±–∫–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã</h2>
        <% if (flexRoutes.length === 0) { %>
            <div class="empty-state">
                <i class="fas fa-search-minus"></i>
                <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –≥–∏–±–∫–∏—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤</p>
            </div>
        <% } else { %>
            <% flexRoutes.forEach(route => { %>
                <div class="route-card">
                    <div class="route-header">
                        <div class="route-title">
                            <%= route.origin %> ‚Üí <%= route.destination %>
                            <% if (route.savings > 0) { %>
                                <span class="badge badge-success">üíé -<%= Math.floor(route.savings).toLocaleString('ru-RU') %> ‚ÇΩ</span>
                            <% } %>
                        </div>
                        <span class="route-status <%= route.is_paused ? 'status-paused' : 'status-active' %>">
                                <%= route.is_paused ? '‚è∏Ô∏è –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' %>
                            </span>
                    </div>

                    <div class="price-section">
                        <div class="price-item">
                            <div class="price-label">üíé –õ—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç</div>
                            <div class="price-value best">
                                <%= route.bestPrice ? Math.floor(route.bestPrice.total_price).toLocaleString('ru-RU') + ' ‚ÇΩ' : '‚Äî' %>
                            </div>
                            <% if (route.bestPrice) { %>
                                <div class="last-check">
                                    <%= route.bestPrice.airline %> |
                                    <script>
                                      document.write((function(){
                                        const d1 = new Date('<%= route.bestPrice.departure_date %>');
                                        const d2 = new Date('<%= route.bestPrice.return_date %>');
                                        return d1.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' }) +
                                          '-' +
                                          d2.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' });
                                      })());
                                    </script>
                                </div>
                            <% } %>
                        </div>
                        <div class="price-item">
                            <div class="price-label">üéØ –í–∞—à –ø–æ—Ä–æ–≥</div>
                            <div class="price-value threshold">
                                <%= route.threshold_price.toLocaleString('ru-RU') %> ‚ÇΩ
                            </div>
                        </div>
                        <div class="price-item">
                            <div class="price-label">üìâ –ü–æ—Å–ª–µ–¥–Ω—è—è</div>
                            <div class="price-value">
                                <%= route.lastCheck ? Math.floor(route.lastCheck.total_price).toLocaleString('ru-RU') + ' ‚ÇΩ' : '‚Äî' %>
                            </div>
                            <% if (route.lastCheck) { %>
                                <div class="last-check">
                                    <script>
                                      document.write((function(){
                                        const d = new Date('<%= route.lastCheck.found_at %>Z');
                                        return d.toLocaleString('ru-RU', {
                                          month: 'short',
                                          day: 'numeric',
                                          hour: '2-digit',
                                          minute: '2-digit',
                                          timeZone: 'Asia/Yekaterinburg',
                                          hour12: false
                                        });
                                      })());
                                    </script>
                                </div>
                            <% } %>
                        </div>
                        <% if (route.savings > 0) { %>
                            <div class="price-item">
                                <div class="price-label">üí∞ –≠–∫–æ–Ω–æ–º–∏—è</div>
                                <div class="price-value savings">
                                    <%= Math.floor(route.savings).toLocaleString('ru-RU') %> ‚ÇΩ
                                </div>
                                <div class="last-check">
                                    <%= Math.floor((route.savings / route.threshold_price) * 100) %>% –æ—Ç –ø–æ—Ä–æ–≥–∞
                                </div>
                            </div>
                        <% } %>
                    </div>

                    <div class="route-info">
                        <div class="info-item">
                            <i class="fas fa-calendar-alt"></i>
                            <span>
                              <script>
                                document.write((function(){
                                  return new Date('<%= route.departure_start %>').toLocaleDateString('ru-RU');
                                })());
                              </script>
                              -
                              <script>
                                document.write((function(){
                                  return new Date('<%= route.departure_end %>').toLocaleDateString('ru-RU');
                                })());
                              </script>
                            </span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-clock"></i>
                            <span><%= route.min_days %>-<%= route.max_days %> –¥–Ω–µ–π</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-plane"></i>
                            <span><%= route.airline || '–õ—é–±–∞—è' %></span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-users"></i>
                            <span><%= route.adults %> –≤–∑—Ä<%= route.children > 0 ? ', ' + route.children + ' –¥–µ—Ç' : '' %></span>
                        </div>
                    </div>

                    <div class="route-actions">
                        <button class="btn btn-success" onclick="showTickets(<%= route.id %>, 'flexible')">
                            üé´ –õ—É—á—à–∏–µ –±–∏–ª–µ—Ç—ã
                        </button>
                        <button class="btn btn-info" onclick="showHistory(<%= route.id %>, 'flexible')">
                            üìä –ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω
                        </button>
                        <button class="btn btn-primary" onclick="togglePause(<%= route.id %>, <%= route.is_paused ? 1 : 0 %>, 'flexible')">
                            <%= route.is_paused ? '‚ñ∂Ô∏è –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å' : '‚è∏Ô∏è –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å' %>
                        </button>
                        <button class="btn btn-warning" onclick="editThreshold(<%= route.id %>, <%= route.threshold_price %>, 'flexible')">
                            üí∞ –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä–æ–≥
                        </button>
                        <button class="btn btn-danger" onclick="deleteRoute(<%= route.id %>, 'flexible')">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            <% }) %>
        <% } %>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body" id="modalBody">
            <p style="text-align: center; padding: 40px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 3em; color: #667eea;"></i>
            </p>
        </div>
    </div>
</div>

<script>
  const chatId = <%= chatId %>;

  function formatTimeAgo(dateString) {
    if (!dateString) return '';
    const utcDate = new Date(dateString + 'Z');
    const options = {
      day: 'numeric',
      month: 'short',
      hour: '2-digit',
      minute: '2-digit',
      timeZone: 'Asia/Yekaterinburg',
      hour12: false
    };
    return utcDate.toLocaleString('ru-RU', options);
  }

  function closeModal() {
    document.getElementById('modal').classList.remove('active');
  }

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  window.onclick = function(event) {
    const modal = document.getElementById('modal');
    if (event.target == modal) {
      closeModal();
    }
  }

  async function showTickets(routeId, type) {
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');

    modalTitle.textContent = 'üé´ –õ—É—á—à–∏–µ –±–∏–ª–µ—Ç—ã';
    modalBody.innerHTML = '<p style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 3em; color: #667eea;"></i></p>';
    modal.classList.add('active');

    try {
      const endpoint = type === 'flexible' ? 'flexible-routes' : 'routes';
      const response = await fetch(`/api/${endpoint}/${routeId}/tickets?chat_id=${chatId}`);
      const tickets = await response.json();

      if (tickets.length === 0) {
        modalBody.innerHTML = '<div class="empty-state"><i class="fas fa-ticket-alt"></i><p>–ë–∏–ª–µ—Ç—ã –ø–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>';
        return;
      }

      let html = '';
      tickets.forEach((ticket, index) => {
        const price = type === 'flexible' ? ticket.total_price : ticket.price;
        const icon = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;

        html += `
                        <div class="ticket-card">
                            <div class="ticket-header">
                                <div>
                                    <div class="ticket-price">${icon} ${Math.floor(price).toLocaleString('ru-RU')} ‚ÇΩ</div>
                                    <div class="ticket-airline">‚úàÔ∏è ${ticket.airline}</div>
                                </div>
                            </div>
                    `;

        if (type === 'flexible') {
          html += `
                            <div class="ticket-date">
                                üìÖ ${new Date(ticket.departure_date).toLocaleDateString('ru-RU')} ‚Üí
                                ${new Date(ticket.return_date).toLocaleDateString('ru-RU')}
                                (${ticket.days_in_country} –¥–Ω–µ–π)
                            </div>
                        `;
        }

        html += `
                            <div class="ticket-date">
                                üïí –ù–∞–π–¥–µ–Ω–æ: ${formatTimeAgo(ticket.found_at)}
                            </div>
                            <a href="${ticket.search_link}" target="_blank" class="ticket-link">
                                üîó –û—Ç–∫—Ä—ã—Ç—å –Ω–∞ Aviasales
                            </a>
                        </div>
                    `;
      });

      modalBody.innerHTML = html;
    } catch (error) {
      modalBody.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–ª–µ—Ç–æ–≤</p></div>';
      console.error('Error:', error);
    }
  }

  async function showHistory(routeId, type) {
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');

    modalTitle.textContent = 'üìä –ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω';
    modalBody.innerHTML = '<p style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 3em; color: #667eea;"></i></p>';
    modal.classList.add('active');

    try {
      const endpoint = type === 'flexible' ? 'flexible-routes' : 'routes';
      const response = await fetch(`/api/${endpoint}/${routeId}/price-history?chat_id=${chatId}`);
      const history = await response.json();

      if (history.length === 0) {
        modalBody.innerHTML = '<div class="empty-state"><i class="fas fa-chart-line"></i><p>–ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω –ø–æ–∫–∞ –ø—É—Å—Ç–∞</p></div>';
        return;
      }

      let html = '';
      history.forEach((item, index) => {
        const price = type === 'flexible' ? item.total_price : item.price;
        let trendIcon = '';
        let trendClass = '';

        if (index < history.length - 1) {
          const prevPrice = type === 'flexible' ? history[index + 1].total_price : history[index + 1].price;
          const diff = price - prevPrice;

          if (diff > 0) {
            trendIcon = `üìà +${Math.floor(diff).toLocaleString('ru-RU')} ‚ÇΩ`;
            trendClass = 'up';
          } else if (diff < 0) {
            trendIcon = `üìâ ${Math.floor(diff).toLocaleString('ru-RU')} ‚ÇΩ`;
            trendClass = 'down';
          } else {
            trendIcon = '‚ûñ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π';
          }
        }

        html += `
                        <div class="history-item">
                            <div>
                                <div class="history-price">${Math.floor(price).toLocaleString('ru-RU')} ‚ÇΩ</div>
                                <div class="history-details">
                                    ‚úàÔ∏è ${item.airline || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
                                    ${type === 'flexible' ? `| üìÖ ${new Date(item.departure_date).toLocaleDateString('ru-RU')}` : ''}
                                </div>
                                <div class="history-details" style="margin-top: 5px;">
                                    üïí ${formatTimeAgo(item.found_at)}
                                </div>
                            </div>
                            <div>
                                ${trendIcon ? `<div class="price-trend ${trendClass}">${trendIcon}</div>` : ''}
                            </div>
                        </div>
                    `;
      });

      modalBody.innerHTML = html;
    } catch (error) {
      modalBody.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</p></div>';
      console.error('Error:', error);
    }
  }

  async function togglePause(routeId, isPaused, type) {
    if (!confirm(isPaused ? '–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç?' : '–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç?')) return;

    const endpoint = type === 'flexible' ? 'flexible-routes' : 'routes';

    try {
      const response = await fetch(`/api/${endpoint}/${routeId}/pause?chat_id=${chatId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_paused: !isPaused })
      });

      if (response.ok) {
        location.reload();
      } else {
        alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞');
      }
    } catch (error) {
      alert('–û—à–∏–±–∫–∞: ' + error.message);
    }
  }

  async function editThreshold(routeId, currentPrice, type) {
    const newPrice = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–æ—Ä–æ–≥ —Ü–µ–Ω—ã:', currentPrice);
    if (!newPrice || isNaN(newPrice)) return;

    const endpoint = type === 'flexible' ? 'flexible-routes' : 'routes';

    try {
      const response = await fetch(`/api/${endpoint}/${routeId}/threshold?chat_id=${chatId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ threshold_price: parseFloat(newPrice) })
      });

      if (response.ok) {
        location.reload();
      } else {
        alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Ä–æ–≥–∞');
      }
    } catch (error) {
      alert('–û—à–∏–±–∫–∞: ' + error.message);
    }
  }

  async function deleteRoute(routeId, type) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

    const endpoint = type === 'flexible' ? 'flexible-routes' : 'routes';

    try {
      const response = await fetch(`/api/${endpoint}/${routeId}?chat_id=${chatId}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        location.reload();
      } else {
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞');
      }
    } catch (error) {
      alert('–û—à–∏–±–∫–∞: ' + error.message);
    }
  }
</script>
</body>
</html>
