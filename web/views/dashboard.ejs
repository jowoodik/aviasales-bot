<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Aviasales Bot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f23;
            color: #e0e0e0;
            font-size: 14px;
        }

        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            border-bottom: 2px solid #667eea;
        }

        .header h1 {
            font-size: 1.4em;
            margin-bottom: 3px;
        }

        .header p {
            opacity: 0.7;
            font-size: 0.85em;
            margin-top: 3px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #1a1a2e;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 1px solid #2d2d44;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: #667eea;
        }

        .stat-card .icon {
            font-size: 1.5em;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
            margin: 8px 0;
        }

        .stat-card .label {
            color: #a0a0a0;
            font-size: 0.85em;
        }

        .stat-card.savings {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border-color: #38ef7d;
        }

        .stat-card.savings .value {
            color: white;
        }

        .stat-card.savings .label {
            color: rgba(255,255,255,0.9);
        }

        .section {
            background: #1a1a2e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            border: 1px solid #2d2d44;
        }

        .section h2 {
            margin-bottom: 15px;
            color: #e0e0e0;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .route-card {
            border: 1px solid #2d2d44;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            background: #16213e;
            transition: all 0.3s;
        }

        .route-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .route-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #e0e0e0;
        }

        .route-status {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-active {
            background: rgba(40, 167, 69, 0.2);
            color: #4ade80;
            border: 1px solid #4ade80;
        }

        .status-paused {
            background: rgba(255, 193, 7, 0.2);
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }

        .price-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin: 12px 0;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
        }

        .price-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .price-label {
            font-size: 0.8em;
            color: #a0a0a0;
            font-weight: 500;
        }

        .price-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #e0e0e0;
        }

        .price-value.best {
            color: #4ade80;
        }

        .price-value.threshold {
            color: #667eea;
        }

        .price-value.savings {
            color: #f87171;
        }

        .route-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 12px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #a0a0a0;
            font-size: 0.85em;
        }

        .route-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #2d2d44;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state i {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .last-check {
            font-size: 0.8em;
            color: #666;
            margin-top: 3px;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: bold;
            margin-left: 6px;
        }

        .badge-success {
            background: rgba(40, 167, 69, 0.2);
            color: #4ade80;
            border: 1px solid #4ade80;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1a1a2e;
            margin: 20px;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            border: 1px solid #2d2d44;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3em;
        }

        .close {
            color: white;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 20px;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –±–∏–ª–µ—Ç–æ–≤ */
        .ticket-card {
            border: 1px solid #2d2d44;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            background: #16213e;
            transition: all 0.3s;
        }

        .ticket-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .ticket-price {
            font-size: 1.6em;
            font-weight: bold;
            color: #4ade80;
        }

        .ticket-airline {
            font-size: 1em;
            color: #a0a0a0;
            font-weight: 500;
        }

        .ticket-date {
            color: #666;
            font-size: 0.85em;
            margin-top: 4px;
        }

        .ticket-link {
            display: inline-block;
            margin-top: 8px;
            padding: 8px 16px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .ticket-link:hover {
            background: #5568d3;
        }

        /* –ì—Ä–∞—Ñ–∏–∫ */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
            background: #16213e;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #2d2d44;
        }

        /* –ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω */
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #2d2d44;
            background: #16213e;
            margin-bottom: 8px;
            border-radius: 6px;
        }

        .history-price {
            font-size: 1.2em;
            font-weight: bold;
            color: #e0e0e0;
        }

        .history-details {
            color: #a0a0a0;
            font-size: 0.85em;
        }

        .price-trend {
            font-size: 0.85em;
            font-weight: bold;
        }

        .price-trend.up {
            color: #dc3545;
        }

        .price-trend.down {
            color: #28a745;
        }

        /* Tabs –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid #2d2d44;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #a0a0a0;
            font-size: 0.9em;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .route-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .modal-content {
                width: 95%;
                margin: 10px;
            }
            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
<div class="header">
    <div class="container">
        <h1>‚úàÔ∏è Dashboard</h1>
        <p>Chat ID: <%= chatId %></p>
        <% if (stats.lastCheckTime) { %>
            <p style="font-size: 0.85em; opacity: 0.7;">
                –ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞:
                <script>
                  (function() {
                    function formatTimeAgo(dateString) {
                      if (!dateString) return '';
                      const utcDate = new Date(dateString + 'Z');
                      const options = {
                        day: 'numeric',
                        month: 'short',
                        hour: '2-digit',
                        minute: '2-digit',
                        timeZone: 'Asia/Yekaterinburg',
                        hour12: false
                      };
                      return utcDate.toLocaleString('ru-RU', options);
                    }
                    document.write(formatTimeAgo('<%= stats.lastCheckTime %>'));
                  })();
                </script>
            </p>
        <% } %>
    </div>
</div>

<div class="container">
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="icon">‚úàÔ∏è</div>
            <div class="value"><%= routes.length %></div>
            <div class="label">–û–±—ã—á–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤</div>
            <% if (stats.activeRoutes !== undefined) { %>
                <div class="last-check">–ê–∫—Ç–∏–≤–Ω—ã—Ö: <%= stats.activeRoutes %></div>
            <% } %>
        </div>
        <div class="stat-card">
            <div class="icon">üîç</div>
            <div class="value"><%= flexRoutes.length %></div>
            <div class="label">–ì–∏–±–∫–∏—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤</div>
            <% if (stats.activeFlexRoutes !== undefined) { %>
                <div class="last-check">–ê–∫—Ç–∏–≤–Ω—ã—Ö: <%= stats.activeFlexRoutes %></div>
            <% } %>
        </div>
        <div class="stat-card">
            <div class="icon">üìä</div>
            <div class="value"><%= stats.total_prices || 0 %></div>
            <div class="label">–ü—Ä–æ–≤–µ—Ä–æ–∫ —Ü–µ–Ω</div>
        </div>
        <div class="stat-card savings">
            <div class="icon">üí∞</div>
            <div class="value"><%= stats.totalSavings ? Math.floor(stats.totalSavings).toLocaleString('ru-RU') : 0 %></div>
            <div class="label">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è (‚ÇΩ)</div>
        </div>
    </div>

    <!-- –û–±—ã—á–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã -->
    <div class="section">
        <h2><i class="fas fa-plane"></i> –û–±—ã—á–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã</h2>
        <% if (routes.length === 0) { %>
            <div class="empty-state">
                <i class="fas fa-plane-slash"></i>
                <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ–±—ã—á–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤</p>
            </div>
        <% } else { %>
            <% routes.forEach(route => { %>
                <div class="route-card">
                    <div class="route-header">
                        <div class="route-title">
                            <%= route.origin %> ‚Üí <%= route.destination %>
                            <% if (route.savings > 0) { %>
                                <span class="badge badge-success">üíé -<%= Math.floor(route.savings).toLocaleString('ru-RU') %> ‚ÇΩ</span>
                            <% } %>
                        </div>
                        <span class="route-status <%= route.is_paused ? 'status-paused' : 'status-active' %>">
                            <%= route.is_paused ? '‚è∏Ô∏è –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' %>
                        </span>
                    </div>

                    <div class="price-section">
                        <div class="price-item">
                            <div class="price-label">üíé –õ—É—á—à–∞—è —Ü–µ–Ω–∞</div>
                            <div class="price-value best">
                                <%= route.bestPrice ? Math.floor(route.bestPrice.price).toLocaleString('ru-RU') + ' ‚ÇΩ' : '‚Äî' %>
                            </div>
                            <% if (route.bestPrice) { %>
                                <div class="last-check">
                                    <%= route.bestPrice.airline %> |
                                    <script>
                                      document.write((function(){
                                        return new Date('<%= route.bestPrice.found_at %>').toLocaleDateString('ru-RU');
                                      })());
                                    </script>
                                </div>
                            <% } %>
                        </div>
                        <div class="price-item">
                            <div class="price-label">üéØ –í–∞—à –ø–æ—Ä–æ–≥</div>
                            <div class="price-value threshold">
                                <%= route.threshold_price.toLocaleString('ru-RU') %> ‚ÇΩ
                            </div>
                        </div>
                        <div class="price-item">
                            <div class="price-label">üìâ –ü–æ—Å–ª–µ–¥–Ω—è—è</div>
                            <div class="price-value">
                                <%= route.lastCheck ? Math.floor(route.lastCheck.price).toLocaleString('ru-RU') + ' ‚ÇΩ' : '‚Äî' %>
                            </div>
                            <% if (route.lastCheck) { %>
                                <div class="last-check">
                                    <script>
                                      document.write((function(){
                                        const d = new Date('<%= route.lastCheck.found_at %>Z');
                                        return d.toLocaleString('ru-RU', {
                                          month: 'short',
                                          day: 'numeric',
                                          hour: '2-digit',
                                          minute: '2-digit',
                                          timeZone: 'Asia/Yekaterinburg',
                                          hour12: false
                                        });
                                      })());
                                    </script>
                                </div>
                            <% } %>
                        </div>
                        <% if (route.savings > 0) { %>
                            <div class="price-item">
                                <div class="price-label">üí∞ –≠–∫–æ–Ω–æ–º–∏—è</div>
                                <div class="price-value savings">
                                    <%= Math.floor(route.savings).toLocaleString('ru-RU') %> ‚ÇΩ
                                </div>
                                <div class="last-check">
                                    <%= Math.floor((route.savings / route.threshold_price) * 100) %>% –æ—Ç –ø–æ—Ä–æ–≥–∞
                                </div>
                            </div>
                        <% } %>
                    </div>

                    <div class="route-info">
                        <div class="info-item">
                            <i class="fas fa-calendar"></i>
                            <span>
                              <script>
                                document.write((function(){
                                  return new Date('<%= route.departure_date %>').toLocaleDateString('ru-RU');
                                })());
                              </script>
                              -
                              <script>
                                document.write((function(){
                                  return new Date('<%= route.return_date %>').toLocaleDateString('ru-RU');
                                })());
                              </script>
                            </span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-users"></i>
                            <span><%= route.adults %> –≤–∑—Ä<%= route.children > 0 ? ', ' + route.children + ' –¥–µ—Ç' : '' %></span>
                        </div>
                        <% if (route.airline) { %>
                            <div class="info-item">
                                <i class="fas fa-plane"></i>
                                <span><%= route.airline %></span>
                            </div>
                        <% } %>
                        <div class="info-item">
                            <i class="fas fa-suitcase"></i>
                            <span><%= route.baggage ? '–° –±–∞–≥–∞–∂–æ–º' : '–ë–µ–∑ –±–∞–≥–∞–∂–∞' %></span>
                        </div>
                        <% if (route.max_layover_hours) { %>
                            <div class="info-item">
                                <i class="fas fa-clock"></i>
                                <span>–ú–∞–∫—Å. –ø–µ—Ä–µ—Å–∞–¥–∫–∞: <%= route.max_layover_hours || 5 %>—á</span>
                            </div>
                        <% } %>
                    </div>

                    <div class="route-actions">
                        <button class="btn btn-info" onclick="showCharts(<%= route.id %>, 'regular')">
                            üìä –ì—Ä–∞—Ñ–∏–∫–∏
                        </button>
                        <button class="btn btn-success" onclick="showTickets(<%= route.id %>, 'regular')">
                            üé´ –õ—É—á—à–∏–µ –±–∏–ª–µ—Ç—ã
                        </button>
                        <button class="btn btn-primary" onclick="togglePause(<%= route.id %>, <%= route.is_paused ? 1 : 0 %>, 'regular')">
                            <%= route.is_paused ? '‚ñ∂Ô∏è –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å' : '‚è∏Ô∏è –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å' %>
                        </button>
                        <button class="btn btn-warning" onclick="editThreshold(<%= route.id %>, <%= route.threshold_price %>, 'regular')">
                            üí∞ –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä–æ–≥
                        </button>
                        <button class="btn btn-danger" onclick="deleteRoute(<%= route.id %>, 'regular')">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            <% }) %>
        <% } %>
    </div>

    <!-- –ì–∏–±–∫–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã -->
    <div class="section">
        <h2><i class="fas fa-search"></i> –ì–∏–±–∫–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã</h2>
        <% if (flexRoutes.length === 0) { %>
            <div class="empty-state">
                <i class="fas fa-search-minus"></i>
                <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –≥–∏–±–∫–∏—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤</p>
            </div>
        <% } else { %>
            <% flexRoutes.forEach(route => { %>
                <div class="route-card">
                    <div class="route-header">
                        <div class="route-title">
                            <%= route.origin %> ‚Üí <%= route.destination %>
                            <% if (route.savings > 0) { %>
                                <span class="badge badge-success">üíé -<%= Math.floor(route.savings).toLocaleString('ru-RU') %> ‚ÇΩ</span>
                            <% } %>
                        </div>
                        <span class="route-status <%= route.is_paused ? 'status-paused' : 'status-active' %>">
                            <%= route.is_paused ? '‚è∏Ô∏è –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' %>
                        </span>
                    </div>

                    <div class="price-section">
                        <div class="price-item">
                            <div class="price-label">üíé –õ—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç</div>
                            <div class="price-value best">
                                <%= route.bestPrice ? Math.floor(route.bestPrice.total_price).toLocaleString('ru-RU') + ' ‚ÇΩ' : '‚Äî' %>
                            </div>
                            <% if (route.bestPrice) { %>
                                <div class="last-check">
                                    <%= route.bestPrice.airline %> |
                                    <script>
                                      document.write((function(){
                                        const d1 = new Date('<%= route.bestPrice.departure_date %>');
                                        const d2 = new Date('<%= route.bestPrice.return_date %>');
                                        return d1.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' }) +
                                          '-' +
                                          d2.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' });
                                      })());
                                    </script>
                                </div>
                            <% } %>
                        </div>
                        <div class="price-item">
                            <div class="price-label">üéØ –í–∞—à –ø–æ—Ä–æ–≥</div>
                            <div class="price-value threshold">
                                <%= route.threshold_price.toLocaleString('ru-RU') %> ‚ÇΩ
                            </div>
                        </div>
                        <div class="price-item">
                            <div class="price-label">üìâ –ü–æ—Å–ª–µ–¥–Ω—è—è</div>
                            <div class="price-value">
                                <%= route.lastCheck ? Math.floor(route.lastCheck.total_price).toLocaleString('ru-RU') + ' ‚ÇΩ' : '‚Äî' %>
                            </div>
                            <% if (route.lastCheck) { %>
                                <div class="last-check">
                                    <script>
                                      document.write((function(){
                                        const d = new Date('<%= route.lastCheck.found_at %>Z');
                                        return d.toLocaleString('ru-RU', {
                                          month: 'short',
                                          day: 'numeric',
                                          hour: '2-digit',
                                          minute: '2-digit',
                                          timeZone: 'Asia/Yekaterinburg',
                                          hour12: false
                                        });
                                      })());
                                    </script>
                                </div>
                            <% } %>
                        </div>
                        <% if (route.savings > 0) { %>
                            <div class="price-item">
                                <div class="price-label">üí∞ –≠–∫–æ–Ω–æ–º–∏—è</div>
                                <div class="price-value savings">
                                    <%= Math.floor(route.savings).toLocaleString('ru-RU') %> ‚ÇΩ
                                </div>
                                <div class="last-check">
                                    <%= Math.floor((route.savings / route.threshold_price) * 100) %>% –æ—Ç –ø–æ—Ä–æ–≥–∞
                                </div>
                            </div>
                        <% } %>
                    </div>

                    <div class="route-info">
                        <div class="info-item">
                            <i class="fas fa-calendar-alt"></i>
                            <span>
                              <script>
                                document.write((function(){
                                  return new Date('<%= route.departure_start %>').toLocaleDateString('ru-RU');
                                })());
                              </script>
                              -
                              <script>
                                document.write((function(){
                                  return new Date('<%= route.departure_end %>').toLocaleDateString('ru-RU');
                                })());
                              </script>
                            </span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-clock"></i>
                            <span><%= route.min_days %>-<%= route.max_days %> –¥–Ω–µ–π</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-plane"></i>
                            <span><%= route.airline || '–õ—é–±–∞—è' %></span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-users"></i>
                            <span><%= route.adults %> –≤–∑—Ä<%= route.children > 0 ? ', ' + route.children + ' –¥–µ—Ç' : '' %></span>
                        </div>
                    </div>

                    <div class="route-actions">
                        <button class="btn btn-info" onclick="showCharts(<%= route.id %>, 'flexible')">
                            üìä –ì—Ä–∞—Ñ–∏–∫–∏
                        </button>
                        <button class="btn btn-success" onclick="showTickets(<%= route.id %>, 'flexible')">
                            üé´ –õ—É—á—à–∏–µ –±–∏–ª–µ—Ç—ã
                        </button>
                        <button class="btn btn-primary" onclick="togglePause(<%= route.id %>, <%= route.is_paused ? 1 : 0 %>, 'flexible')">
                            <%= route.is_paused ? '‚ñ∂Ô∏è –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å' : '‚è∏Ô∏è –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å' %>
                        </button>
                        <button class="btn btn-warning" onclick="editThreshold(<%= route.id %>, <%= route.threshold_price %>, 'flexible')">
                            üí∞ –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä–æ–≥
                        </button>
                        <button class="btn btn-danger" onclick="deleteRoute(<%= route.id %>, 'flexible')">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            <% }) %>
        <% } %>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body" id="modalBody">
            <p style="text-align: center; padding: 40px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 3em; color: #667eea;"></i>
            </p>
        </div>
    </div>
</div>

<script>
  const chatId = <%= chatId %>;

  function formatTimeAgo(dateString) {
    if (!dateString) return '';
    const utcDate = new Date(dateString + 'Z');
    const options = {
      day: 'numeric',
      month: 'short',
      hour: '2-digit',
      minute: '2-digit',
      timeZone: 'Asia/Yekaterinburg',
      hour12: false
    };
    return utcDate.toLocaleString('ru-RU', options);
  }

  function closeModal() {
    document.getElementById('modal').classList.remove('active');
  }

  window.onclick = function(event) {
    const modal = document.getElementById('modal');
    if (event.target == modal) {
      closeModal();
    }
  }

  async function showCharts(routeId, type) {
      const modal = document.getElementById('modal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');

      modalTitle.textContent = 'üìä –ì—Ä–∞—Ñ–∏–∫–∏ —Ü–µ–Ω';
      modalBody.innerHTML = '<p style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 3em; color: #667eea;"></i></p>';
      modal.classList.add('active');

      try {
          const endpoint = type === 'flexible' ? 'flexible-routes' : 'routes';
          const url = `/api/${endpoint}/${routeId}/analytics?chat_id=${chatId}`;

          console.log('[DEBUG] –ó–∞–ø—Ä–æ—Å –∫:', url);

          const response = await fetch(url);

          console.log('[DEBUG] –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);

          if (!response.ok) {
              const error = await response.json();
              console.error('[DEBUG] –û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞:', error);
              modalBody.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>–û—à–∏–±–∫–∞: ${error.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p></div>`;
              return;
          }

          const data = await response.json();

          console.log('[DEBUG] –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', {
              priceHistory: data.priceHistory ? data.priceHistory.length : 0,
              heatmap: data.heatmap ? data.heatmap.length : 0
          });

          console.log('[DEBUG] –ü–µ—Ä–≤—ã–µ –∑–∞–ø–∏—Å–∏ priceHistory:', data.priceHistory?.slice(0, 3));
          console.log('[DEBUG] –ü–µ—Ä–≤—ã–µ –∑–∞–ø–∏—Å–∏ heatmap:', data.heatmap?.slice(0, 5));

          if (!data || (!data.priceHistory && !data.heatmap)) {
              console.log('[DEBUG] –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –æ—Ç–≤–µ—Ç–µ');
              modalBody.innerHTML = '<div class="empty-state"><i class="fas fa-chart-line"></i><p>–î–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p></div>';
              return;
          }

          if ((!data.priceHistory || data.priceHistory.length === 0) &&
              (!data.heatmap || data.heatmap.length === 0)) {
              console.log('[DEBUG] –ú–∞—Å—Å–∏–≤—ã –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç—ã');
              modalBody.innerHTML = '<div class="empty-state"><i class="fas fa-chart-line"></i><p>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤.<br>–ì—Ä–∞—Ñ–∏–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ —Ü–µ–Ω.</p></div>';
              return;
          }

          // –°–æ–∑–¥–∞–µ–º tabs –∏ canvas –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
          modalBody.innerHTML = `
      <div class="tabs">
        <button class="tab active" onclick="switchTab(event, 'price-chart')">üìà –î–∏–Ω–∞–º–∏–∫–∞ —Ü–µ–Ω (${data.priceHistory ? data.priceHistory.length : 0})</button>
        <button class="tab" onclick="switchTab(event, 'heatmap-chart')">üî• –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ (${data.heatmap ? data.heatmap.length : 0})</button>
      </div>
      <div id="price-chart" class="tab-content active">
        <div class="chart-container">
          <canvas id="priceCanvas"></canvas>
        </div>
      </div>
      <div id="heatmap-chart" class="tab-content">
        <div class="chart-container">
          <canvas id="heatmapCanvas"></canvas>
        </div>
      </div>
    `;

          // –ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏ —Ü–µ–Ω
          if (data.priceHistory && data.priceHistory.length > 0) {
              console.log('[DEBUG] –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏ —Ü–µ–Ω');
              const ctx = document.getElementById('priceCanvas').getContext('2d');
              const labels = data.priceHistory.map(item => {
                  const d = new Date(item.date);
                  return d.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' });
              });
              const minPrices = data.priceHistory.map(item => item.min_price);
              const maxPrices = data.priceHistory.map(item => item.max_price);
              const avgPrices = data.priceHistory.map(item => item.avg_price);

              console.log('[DEBUG] –î–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞:', {
                  labels: labels.length,
                  minPrices: minPrices.length,
                  maxPrices: maxPrices.length,
                  avgPrices: avgPrices.length
              });

              new Chart(ctx, {
                  type: 'line',
                  data: {
                      labels: labels,
                      datasets: [
                          {
                              label: '–ú–∏–Ω. —Ü–µ–Ω–∞',
                              data: minPrices,
                              borderColor: '#4ade80',
                              backgroundColor: 'rgba(74, 222, 128, 0.1)',
                              borderWidth: 2,
                              tension: 0.4,
                              fill: true
                          },
                          {
                              label: '–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞',
                              data: avgPrices,
                              borderColor: '#667eea',
                              backgroundColor: 'rgba(102, 126, 234, 0.1)',
                              borderWidth: 2,
                              tension: 0.4,
                              fill: false
                          },
                          {
                              label: '–ú–∞–∫—Å. —Ü–µ–Ω–∞',
                              data: maxPrices,
                              borderColor: '#f87171',
                              backgroundColor: 'rgba(248, 113, 113, 0.1)',
                              borderWidth: 2,
                              tension: 0.4,
                              fill: false
                          }
                      ]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                          legend: {
                              labels: {
                                  color: '#e0e0e0'
                              }
                          },
                          tooltip: {
                              backgroundColor: '#1a1a2e',
                              titleColor: '#e0e0e0',
                              bodyColor: '#e0e0e0',
                              borderColor: '#2d2d44',
                              borderWidth: 1
                          }
                      },
                      scales: {
                          y: {
                              ticks: {
                                  color: '#a0a0a0',
                                  callback: function(value) {
                                      return Math.floor(value).toLocaleString('ru-RU') + ' ‚ÇΩ';
                                  }
                              },
                              grid: {
                                  color: '#2d2d44'
                              }
                          },
                          x: {
                              ticks: {
                                  color: '#a0a0a0'
                              },
                              grid: {
                                  color: '#2d2d44'
                              }
                          }
                      }
                  }
              });

              console.log('[DEBUG] –ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏ —Å–æ–∑–¥–∞–Ω');
          } else {
              console.log('[DEBUG] –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –¥–∏–Ω–∞–º–∏–∫–∏');
              document.getElementById('price-chart').innerHTML =
                  '<div class="empty-state"><i class="fas fa-chart-line"></i><p>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –¥–∏–Ω–∞–º–∏–∫–∏</p></div>';
          }

          // –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞
          if (data.heatmap && data.heatmap.length > 0) {
              console.log('[DEBUG] –†–∏—Å—É–µ–º —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É');
              const ctx = document.getElementById('heatmapCanvas').getContext('2d');

              const dayNames = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];

              // –ù–∞—Ö–æ–¥–∏–º min/max –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Ü–≤–µ—Ç–∞
              const prices = data.heatmap.map(i => i.avg_price);
              const maxPrice = Math.max(...prices);
              const minPrice = Math.min(...prices);

              console.log('[DEBUG] –î–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω heatmap:', { min: minPrice, max: maxPrice });

              // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è bubble chart —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
              const bubbleData = data.heatmap.map(item => {
                  const normalized = (item.avg_price - minPrice) / (maxPrice - minPrice);
                  const r = Math.floor(255 * normalized);
                  const g = Math.floor(255 * (1 - normalized));

                  return {
                      x: item.hour_of_day,
                      y: item.day_of_week,
                      r: 12, // —Ä–∞–¥–∏—É—Å –ø—É–∑—ã—Ä—å–∫–∞
                      price: item.avg_price,
                      bgColor: `rgba(${r}, ${g}, 100, 0.8)`
                  };
              });

              console.log('[DEBUG] –ü–µ—Ä–≤—ã–µ bubble —Ç–æ—á–∫–∏:', bubbleData.slice(0, 3));

              new Chart(ctx, {
                  type: 'bubble',
                  data: {
                      datasets: [{
                          label: '–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞',
                          data: bubbleData,
                          backgroundColor: function(context) {
                              // ‚ö†Ô∏è –ò–°–ü–†–ê–í–õ–ï–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º context.raw.bgColor
                              return context.raw?.bgColor || 'rgba(102, 126, 234, 0.5)';
                          },
                          borderWidth: 1,
                          borderColor: '#2d2d44'
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                          legend: {
                              display: false
                          },
                          tooltip: {
                              backgroundColor: '#1a1a2e',
                              titleColor: '#e0e0e0',
                              bodyColor: '#e0e0e0',
                              borderColor: '#2d2d44',
                              borderWidth: 1,
                              callbacks: {
                                  label: function(context) {
                                      const day = dayNames[context.parsed.y];
                                      const hour = `${context.parsed.x}:00`;
                                      const price = Math.floor(context.raw.price).toLocaleString('ru-RU');
                                      return `${day}, ${hour}: ${price} ‚ÇΩ`;
                                  }
                              }
                          }
                      },
                      scales: {
                          y: {
                              type: 'linear',
                              min: -0.5,
                              max: 6.5,
                              ticks: {
                                  stepSize: 1,
                                  color: '#a0a0a0',
                                  callback: function(value) {
                                      const idx = Math.round(value);
                                      return (idx >= 0 && idx <= 6) ? dayNames[idx] : '';
                                  }
                              },
                              grid: {
                                  color: '#2d2d44'
                              }
                          },
                          x: {
                              type: 'linear',
                              min: -0.5,
                              max: 23.5,
                              ticks: {
                                  stepSize: 3,
                                  color: '#a0a0a0',
                                  callback: function(value) {
                                      return Number.isInteger(value) ? `${value}:00` : '';
                                  }
                              },
                              grid: {
                                  color: '#2d2d44'
                              }
                          }
                      }
                  }
              });

              console.log('[DEBUG] –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞');
          } else {
              console.log('[DEBUG] –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã');
              document.getElementById('heatmap-chart').innerHTML =
                  '<div class="empty-state"><i class="fas fa-chart-bar"></i><p>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã</p></div>';
          }
      } catch (error) {
          console.error('[DEBUG] –û—à–∏–±–∫–∞:', error);
          modalBody.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤: ${error.message}</p></div>`;
      }
  }

  function switchTab(event, tabId) {
      // –£–±–∏—Ä–∞–µ–º active —Å–æ –≤—Å–µ—Ö tabs
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      // –î–æ–±–∞–≤–ª—è–µ–º active –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É
      event.target.classList.add('active');
      document.getElementById(tabId).classList.add('active');
  }

  async function showTickets(routeId, type) {
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');

    modalTitle.textContent = 'üé´ –õ—É—á—à–∏–µ –±–∏–ª–µ—Ç—ã';
    modalBody.innerHTML = '<p style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 3em; color: #667eea;"></i></p>';
    modal.classList.add('active');

    try {
      const endpoint = type === 'flexible' ? 'flexible-routes' : 'routes';
      const response = await fetch(`/api/${endpoint}/${routeId}/tickets?chat_id=${chatId}`);
      const tickets = await response.json();

      if (tickets.length === 0) {
        modalBody.innerHTML = '<div class="empty-state"><i class="fas fa-ticket-alt"></i><p>–ë–∏–ª–µ—Ç—ã –ø–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>';
        return;
      }

      let html = '';
      tickets.forEach((ticket, index) => {
        const price = type === 'flexible' ? ticket.total_price : ticket.price;
        const icon = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;

        html += `
          <div class="ticket-card">
            <div class="ticket-header">
              <div>
                <div class="ticket-price">${icon} ${Math.floor(price).toLocaleString('ru-RU')} ‚ÇΩ</div>
                <div class="ticket-airline">‚úàÔ∏è ${ticket.airline}</div>
              </div>
            </div>
        `;

        if (type === 'flexible') {
          html += `
            <div class="ticket-date">
              üìÖ ${new Date(ticket.departure_date).toLocaleDateString('ru-RU')} ‚Üí
              ${new Date(ticket.return_date).toLocaleDateString('ru-RU')}
              (${ticket.days_in_country} –¥–Ω–µ–π)
            </div>
          `;
        }

        html += `
            <div class="ticket-date">
              üïí –ù–∞–π–¥–µ–Ω–æ: ${formatTimeAgo(ticket.found_at)}
            </div>
            <a href="${ticket.search_link}" target="_blank" class="ticket-link">
              üîó –û—Ç–∫—Ä—ã—Ç—å –Ω–∞ Aviasales
            </a>
          </div>
        `;
      });

      modalBody.innerHTML = html;
    } catch (error) {
      modalBody.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–ª–µ—Ç–æ–≤</p></div>';
      console.error('Error:', error);
    }
  }

  async function togglePause(routeId, isPaused, type) {
    if (!confirm(isPaused ? '–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç?' : '–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç?')) return;

    const endpoint = type === 'flexible' ? 'flexible-routes' : 'routes';

    try {
      const response = await fetch(`/api/${endpoint}/${routeId}/pause?chat_id=${chatId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_paused: !isPaused })
      });

      if (response.ok) {
        location.reload();
      } else {
        alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞');
      }
    } catch (error) {
      alert('–û—à–∏–±–∫–∞: ' + error.message);
    }
  }

  async function editThreshold(routeId, currentPrice, type) {
    const newPrice = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–æ—Ä–æ–≥ —Ü–µ–Ω—ã:', currentPrice);
    if (!newPrice || isNaN(newPrice)) return;

    const endpoint = type === 'flexible' ? 'flexible-routes' : 'routes';

    try {
      const response = await fetch(`/api/${endpoint}/${routeId}/threshold?chat_id=${chatId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ threshold_price: parseFloat(newPrice) })
      });

      if (response.ok) {
        location.reload();
      } else {
        alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Ä–æ–≥–∞');
      }
    } catch (error) {
      alert('–û—à–∏–±–∫–∞: ' + error.message);
    }
  }

  async function deleteRoute(routeId, type) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

    const endpoint = type === 'flexible' ? 'flexible-routes' : 'routes';

    try {
      const response = await fetch(`/api/${endpoint}/${routeId}?chat_id=${chatId}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        location.reload();
      } else {
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞');
      }
    } catch (error) {
      alert('–û—à–∏–±–∫–∞: ' + error.message);
    }
  }
</script>
</body>
</html>
